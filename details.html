<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="templatemo">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <title>News Radar - Centralizado</title>
  
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/css/news-carousel.css">
</head>

<body>

  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner"><span class="dot"></span><div class="dots"><span></span><span></span><span></span></div></div>
  </div>

  <header class="header-area header-sticky">
    <div class="container">
      <div class="row"><div class="col-12">
        <nav class="main-nav">
          <a href="index.html" class="logo"><img src="assets/images/logo.png" alt=""></a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="create.html">Transcritor de Podcast</a></li>
            <li><a href="details.html" class="active">News Radar</a></li>
          </ul>
          <a class='menu-trigger'><span>Menu</span></a>
        </nav>
      </div></div>
    </div>
  </header>

  <div class="page-heading normal-space">
    <div class="container"><div class="row"><div class="col-lg-12">
      <h2>Daily Tech News Curator</h2>
      <p style="color: #7453f8; font-weight: bold;">Sincronizado com Banco de Dados Global</p>
    </div></div></div>
  </div>

  <div class="item-details-page">
    <div class="container"><div class="row">

      <div class="col-lg-12">
        <div class="section-heading">
          <div class="line-dec"></div>
          <h2>Tech <em>Intelligence Radar</em></h2>
        </div>
      </div>

      <div class="col-lg-12 text-center" style="margin-bottom: 40px;">
        <div class="main-button">
          <a href="javascript:void(0)" id="btn-refresh-news" style="background-color: #00ffcc; border-color: #00ffcc; color: #333; font-weight: bold; padding: 10px 25px;">
             Atualizar Not√≠cias Agora
          </a>
        </div>
        <p id="refresh-status" style="color: #00ffcc; font-size: 12px; margin-top: 10px; display: none;">Sincronizando com GNews e atualizando banco global...</p>
      </div>

      <div class="col-lg-12" id="news-feed-container">
        <h5 class="text-center" style="color:white;padding:50px;">Buscando as not√≠cias mais recentes no banco...</h5>
      </div>

      <div class="col-lg-12 text-center" style="margin-top:30px;">
        <div id="load-more-container" style="display:none;">
          <div class="border-button">
            <a href="javascript:void(0)" id="btn-load-more">Mostrar dias anteriores</a>
          </div>
        </div>
        <div class="main-button" style="margin-top:30px;">
          <a href="javascript:void(0)" id="btn-generate-report"
             style="display:none;background-color:#7453f8;border-color:#7453f8;padding:15px 30px;">
            ‚ú® Generate AI Report (Selected: <span id="count">0</span>)
          </a>
        </div>
      </div>

      <!-- ===================== AI REPORT SECTION (NOVO) ===================== -->
      <div class="col-lg-12" id="summary-section" style="display:none;margin-top:60px;">
        <div class="section-heading">
          <div class="line-dec"></div>
          <h2>AI <em>Executive Summary</em></h2>
        </div>

        <!-- TAB NAVIGATION -->
        <div class="report-tabs" style="display:flex; gap:0; margin-bottom:0;">
          <button class="report-tab-btn active" data-tab="tab-summary">
            üìã Resumo Executivo
          </button>
          <button class="report-tab-btn" data-tab="tab-relevance">
            üè¢ Por que √© relevante para a Radix?
          </button>
        </div>

        <!-- TAB: RESUMO -->
        <div id="tab-summary" class="report-tab-content active">
          <div id="summary-output" class="report-box">
            <p style="color:#aaa;padding:20px;">‚ö° Aguardando gera√ß√£o do relat√≥rio...</p>
          </div>
        </div>

        <!-- TAB: RELEV√ÇNCIA RADIX -->
        <div id="tab-relevance" class="report-tab-content">
          <div id="relevance-output" class="report-box">
            <p style="color:#aaa;padding:20px;">‚ö° Aguardando an√°lise de relev√¢ncia...</p>
          </div>
        </div>

      </div>
      <!-- ================================================================== -->

    </div></div>
  </div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
  // ================= ESTADO GLOBAL =================
  let newsByDate = {};
  let selectedArticles = [];
  let displayedDatesCount = 0;
  const DATES_PER_LOAD = 2;

  $(document).ready(async () => {
    await carregarNoticiasGlobais();
  });

  // ================= CARREGAMENTO VIA API + KV =================
  async function carregarNoticiasGlobais(force = false) {
    try {
      if(force) $('#refresh-status').fadeIn();

      const url = force ? '/api/news?force=true' : '/api/news';
      const response = await fetch(url);
      const articles = await response.json();

      if (!articles || articles.length === 0) {
        $('#news-feed-container').html('<h5 class="text-center" style="color:white;padding:50px;">Nenhuma not√≠cia sincronizada no momento.</h5>');
        return;
      }

      newsByDate = {};
      displayedDatesCount = 0;
      selectedArticles = [];
      $('#count').text('0');
      $('#btn-generate-report').hide();

      articles.forEach(art => {
        const dt = new Date(art.publishedAt);
        const dateKey = dt.toLocaleDateString('pt-BR');
        if (!newsByDate[dateKey]) newsByDate[dateKey] = [];
        newsByDate[dateKey].push(art);
      });

      $('#news-feed-container').empty();
      renderNextBatch();
      $('#refresh-status').fadeOut();

    } catch (e) {
      console.error('Erro ao carregar not√≠cias:', e);
      $('#news-feed-container').html('<h5 class="text-center" style="color:#ff6b6b;padding:50px;">Erro ao sincronizar com o banco de dados central.</h5>');
      $('#refresh-status').fadeOut();
    }
  }

  // ================= EVENTO DO BOT√ÉO ATUALIZAR =================
  $('#btn-refresh-news').on('click', async function() {
    const $btn = $(this);
    $btn.css('pointer-events', 'none').css('opacity', '0.5').text('‚è≥ Atualizando...');
    await carregarNoticiasGlobais(true);
    $btn.css('pointer-events', 'auto').css('opacity', '1').text('üîÑ Atualizar Not√≠cias Agora');
  });

  // ================= RENDERIZA√á√ÉO EM LOTES =================
  async function renderNextBatch() {
    const container = $('#news-feed-container');
    const sortedDates = getSortedDates();
    const batch = sortedDates.slice(displayedDatesCount, displayedDatesCount + DATES_PER_LOAD);

    for (const date of batch) {
      const safeId = `carousel-${date.replace(/\//g,'-')}`;
      const articles = newsByDate[date];
      const cardsHtml = await buildCards(articles);

      const sectionHtml = `
        <div class="carousel-date-row" style="margin-bottom:50px;">
          <h4 class="date-section-header" style="color:#fff; margin-bottom:20px; font-size:20px;">
            üìÖ ${date} <span style="font-size:14px; color:#7453f8;">(${articles.length} not√≠cias)</span>
          </h4>
          <div id="${safeId}" class="owl-carousel owl-theme news-carousel">
            ${cardsHtml}
          </div>
        </div>`;
      
      container.append(sectionHtml);
      initOwlCarousel($(`#${safeId}`));
    }

    displayedDatesCount += batch.length;
    syncLoadMoreButton();
  }

  function initOwlCarousel($el) {
    $el.owlCarousel({
      items: 3, margin: 30, dots: false, nav: true,
      navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
      responsive: { 0: { items: 1 }, 768: { items: 2 }, 1200: { items: 3 } }
    });
  }

  async function buildCards(articles) {
    let html = '';
    articles.sort((a,b) => new Date(b.publishedAt) - new Date(a.publishedAt));

    for (const art of articles) {
      const tags = generateSmartTags(art.title, art.description);
      const title = (art.title || 'Sem t√≠tulo').replace(/"/g,'&quot;');
      const desc = (art.description || 'Sem descri√ß√£o').replace(/"/g,'&quot;');
      const img = art.image || 'assets/images/current-01.jpg';
      const source = art.source?.name || 'News';
      const urlNoticia = art.url || '#';

      html += `
        <div class="item">
          <div class="news-item-card">
            <input type="checkbox" class="news-checkbox" data-title="${title}" data-desc="${desc}" data-source="${source}">
            <div class="news-image-container">
              <img src="${img}" alt="News" loading="lazy" onerror="this.src='assets/images/current-01.jpg'">
            </div>
            <div class="news-content-area">
              <h4>${art.title || 'Sem T√≠tulo'}</h4>
              <a href="${urlNoticia}" target="_blank" class="source-link" title="Ler no site original">
                <span class="source-tag">@${source}</span>
              </a>
              <p>${art.description || 'Clique para ler a mat√©ria completa.'}</p>
              <div class="tags-list">${tags}</div>
            </div>
          </div>
        </div>`;
    }
    return html;
  }

  function generateSmartTags(title, desc) {
    const text = (title + " " + desc).toLowerCase();
    let foundTags = [];
    const taxonomy = {
      'AI': ['gpt', 'openai', 'gemini', 'generative', 'ia'],
      'HARDWARE': ['nvidia', 'amd', 'chip', 'gpu'],
      'CYBER': ['hacker', 'security', 'vulnerability', 'seguran√ßa']
    };
    for (const [category, keywords] of Object.entries(taxonomy)) {
      if (keywords.some(k => text.includes(k))) foundTags.push(category);
    }
    if (foundTags.length === 0) foundTags.push('TECH');
    return foundTags.slice(0, 2).map(t => `<span class="news-tag" style="background:#7453f8; color:white; padding:2px 8px; border-radius:10px; font-size:10px; margin-right:5px;">${t}</span>`).join('');
  }

  function getSortedDates() {
    return Object.keys(newsByDate).sort((a,b) => {
      const parse = s => { const [d,m,y]=s.split('/'); return new Date(y,m-1,d); };
      return parse(b) - parse(a);
    });
  }

  function syncLoadMoreButton() {
    const total = getSortedDates().length;
    if (displayedDatesCount >= total) $('#load-more-container').hide();
    else $('#load-more-container').show();
  }

  // ================= TROCA DE ABAS =================
  $(document).on('click', '.report-tab-btn', function() {
    const target = $(this).data('tab');
    $('.report-tab-btn').removeClass('active');
    $('.report-tab-content').removeClass('active');
    $(this).addClass('active');
    $(`#${target}`).addClass('active');
  });

  // ================= EVENTOS DE SELE√á√ÉO =================
  $(document).on('change', '.news-checkbox', function() {
    const card = $(this).closest('.news-item-card');
    const data = { title: $(this).data('title'), desc: $(this).data('desc'), source: $(this).data('source') };
    
    if (this.checked) {
      card.addClass('selected');
      selectedArticles.push(data);
    } else {
      card.removeClass('selected');
      selectedArticles = selectedArticles.filter(a => a.title !== data.title);
    }
    
    $('#count').text(selectedArticles.length);
    if (selectedArticles.length > 0) $('#btn-generate-report').fadeIn();
    else $('#btn-generate-report').fadeOut();
  });

  $('#btn-load-more').on('click', () => renderNextBatch());

  // ================= GERA√á√ÉO DO REPORT COM DUAS ABAS =================
  $('#btn-generate-report').on('click', function() {
    const $btn = $(this);
    $btn.text('ü§ñ AI ANALYZING...').css('pointer-events','none');

    // Mostra a se√ß√£o e ativa a primeira aba
    $('#summary-section').fadeIn();
    $('.report-tab-btn[data-tab="tab-summary"]').trigger('click');

    // Loading nas duas abas
    $('#summary-output').html('<div class="report-loading"><span class="report-spinner"></span> Gerando resumo executivo...</div>');
    $('#relevance-output').html('<div class="report-loading"><span class="report-spinner"></span> Analisando relev√¢ncia para a Radix...</div>');

    $('html,body').animate({ scrollTop: $('#summary-section').offset().top - 80 }, 600);

    // Monta o input de artigos
    let articlesInput = "";
    selectedArticles.forEach((art, i) => {
      articlesInput += `\nARTIGO ${i+1}:\nT√≠tulo: ${art.title}\nDescri√ß√£o: ${art.desc}\nFonte: ${art.source}\n`;
    });

    // ---- CHAMADA 1: Resumo Executivo ----
    const callSummary = $.ajax({
      url: '/api/chat',
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      data: JSON.stringify({
        messages: [
          {
            role: 'system',
            content: 'Voc√™ √© um curador de tecnologia. Analise os artigos fornecidos e gere um resumo executivo aprofundado em portugu√™s, com profundidade t√©cnica. Use tags HTML como <b>, <br> e <ul><li> para formatar bem o conte√∫do.'
          },
          { role: 'user', content: articlesInput }
        ],
        temperature: 0.3
      })
    });

    // ---- CHAMADA 2: Relev√¢ncia para a Radix ----
    const RADIX_CONTEXT = `
A Radix √© uma empresa brasileira de engenharia e tecnologia com atua√ß√£o nas seguintes frentes:
- Oil & Gas: projetos de automa√ß√£o, controle, instrumenta√ß√£o e digital twin para ind√∫stria de petr√≥leo e g√°s (Petrobras e outras operadoras);
- Ind√∫stria 4.0 e Manufatura: implementa√ß√£o de MES, SCADA, IIoT, integra√ß√£o OT/IT e automa√ß√£o industrial;
- Engenharia de Software e Sistemas: desenvolvimento de plataformas digitais, sistemas embarcados e solu√ß√µes customizadas;
- Data & Analytics / IA: modelos preditivos, dashboards industriais, machine learning aplicado a ativos industriais e processos;
- Seguran√ßa e Infraestrutura: ciberseguran√ßa industrial (OT/IT), cloud, redes e compliance.
A apresenta√ß√£o quinzenal de not√≠cias tem como objetivo identificar tend√™ncias, riscos e oportunidades que impactam diretamente os setores e projetos em que a Radix atua.`;

    const callRelevance = $.ajax({
      url: '/api/chat',
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      data: JSON.stringify({
        messages: [
          {
            role: 'system',
            content: `Voc√™ √© um analista estrat√©gico especializado em tecnologia e neg√≥cios industriais. 
${RADIX_CONTEXT}

Sua tarefa √© analisar os artigos fornecidos e explicar, de forma estrat√©gica e objetiva em portugu√™s, POR QUE cada not√≠cia √© relevante para a Radix. Para cada artigo, indique:
1. Qual(is) setor(es) da Radix s√£o mais impactados (ex: Oil & Gas, Ind√∫stria 4.0, Data & IA, etc.)
2. O impacto concreto: oportunidade de neg√≥cio, risco, tend√™ncia que afeta projetos em andamento, ou tecnologia que pode ser incorporada
3. Uma recomenda√ß√£o curta: o que a equipe deveria monitorar ou considerar

Use tags HTML para formatar: <b> para destaques, <br> para quebras, e uma estrutura clara por artigo. Seja direto e estrat√©gico ‚Äî este conte√∫do ser√° usado em uma apresenta√ß√£o executiva quinzenal.`
          },
          { role: 'user', content: articlesInput }
        ],
        temperature: 0.4
      })
    });

    // ---- Aguarda as duas chamadas ----
    $.when(callSummary, callRelevance).then(
      // Sucesso das duas
      function(resSummary, resRelevance) {
        const summaryText = resSummary[0].content.replace(/\n/g, '<br>');
        const relevanceText = resRelevance[0].content.replace(/\n/g, '<br>');

        $('#summary-output').html(`<div class="report-content">${summaryText}</div>`);
        $('#relevance-output').html(`<div class="report-content">${relevanceText}</div>`);

        $btn.text(`‚ú® Generate AI Report (Selected: ${selectedArticles.length})`).css('pointer-events','auto');
      },
      // Erro em qualquer uma
      function() {
        $('#summary-output').html('<p style="color:#ff6b6b;padding:20px;">‚ö†Ô∏è Erro ao gerar resumo. Tente novamente.</p>');
        $('#relevance-output').html('<p style="color:#ff6b6b;padding:20px;">‚ö†Ô∏è Erro ao gerar an√°lise. Tente novamente.</p>');
        $btn.text('‚ú® Generate AI Report').css('pointer-events','auto');
      }
    );
  });
  </script>

  <style>
    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .news-item-card { position: relative; transition: all 0.3s; border-radius: 20px; overflow: hidden; background: #282b2f; padding-bottom: 20px; }
    .news-item-card.selected { border: 2px solid #7453f8; transform: scale(0.98); }
    .news-checkbox { position: absolute; top: 15px; right: 15px; z-index: 10; width: 20px; height: 20px; cursor: pointer; }
    .news-image-container img { width: 100%; height: 200px; object-fit: cover; }
    .news-content-area { padding: 20px; }
    .news-content-area h4 { font-size: 18px; color: #fff; margin-bottom: 10px; height: 50px; overflow: hidden; }
    .source-tag { font-size: 12px; color: #7453f8; display: block; margin-bottom: 10px; }
    .news-content-area p { font-size: 14px; color: #afafaf; height: 60px; overflow: hidden; }
    .date-section-header { border-left: 4px solid #7453f8; padding-left: 15px; margin-top: 30px; }

    /* ‚îÄ‚îÄ Report Tabs ‚îÄ‚îÄ */
    .report-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
      border-bottom: 2px solid #333;
    }
    .report-tab-btn {
      background: #1a1a1a;
      color: #aaa;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 14px 28px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s;
      letter-spacing: 0.3px;
      margin-bottom: -2px;
    }
    .report-tab-btn:hover {
      color: #fff;
      background: #242424;
    }
    .report-tab-btn.active {
      color: #fff;
      background: #1e1e1e;
      border-bottom: 3px solid #7453f8;
    }
    .report-tab-btn[data-tab="tab-relevance"].active {
      border-bottom-color: #00ffcc;
      color: #00ffcc;
    }

    /* ‚îÄ‚îÄ Tab Content ‚îÄ‚îÄ */
    .report-tab-content {
      display: none;
    }
    .report-tab-content.active {
      display: block;
    }

    /* ‚îÄ‚îÄ Report Box ‚îÄ‚îÄ */
    .report-box {
      color: #eee;
      font-size: 15px;
      line-height: 1.85;
      text-align: left;
      padding: 30px 35px;
      background: #1e1e1e;
      border-radius: 0 0 20px 20px;
      border: 1px solid #333;
      border-top: none;
      min-height: 160px;
    }
    .report-content b { color: #c5b7ff; }
    #tab-relevance .report-content b { color: #00ffcc; }

    /* ‚îÄ‚îÄ Loading spinner ‚îÄ‚îÄ */
    .report-loading {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #888;
      padding: 20px 0;
      font-size: 14px;
    }
    .report-spinner {
      width: 18px;
      height: 18px;
      border: 3px solid #444;
      border-top-color: #7453f8;
      border-radius: 50%;
      display: inline-block;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }
    #tab-relevance .report-spinner { border-top-color: #00ffcc; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

</body>
</html>