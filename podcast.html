<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <title>Podcast Radar</title>

  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/animate.css">

  
</head>

<body>
  <!-- HEADER -->
  <header class="header-area header-sticky">
    <div class="container">
      <div class="row"><div class="col-12">
        <nav class="main-nav">
          <a href="index.html" class="logo">‚¨° Radar</a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="create.html">Transcritor de Podcast</a></li>
            <li><a href="details.html">News Radar</a></li>
            <li><a href="podcast-radar.html" class="active">Podcast Radar</a></li>
            <li><a href="table.html">Newsboard</a></li>
          </ul>
          <a class="menu-trigger"><span>Menu</span></a>
        </nav>
      </div></div>
    </div>
  </header>

  <!-- PAGE HEADING -->
  <div class="page-heading normal-space">
    <div class="container"><div class="row"><div class="col-lg-12">
      <h2>Podcast Radar</h2>
      <p>Extraia e explore os links de not√≠cias diretamente das descri√ß√µes dos epis√≥dios</p>
    </div></div></div>
  </div>

  <!-- DRAWER OVERLAY -->
  <div id="drawer-overlay"></div>

  <!-- EPISODE DRAWER -->
  <div id="episode-drawer">
    <div class="drawer-header">
      <img id="drawer-thumb" src="" class="drawer-podcast-thumb" alt="">
      <div class="drawer-podcast-meta">
        <div id="drawer-name" class="drawer-podcast-name">‚Äî</div>
        <div id="drawer-author" class="drawer-podcast-author">‚Äî</div>
      </div>
      <button class="drawer-close" id="drawer-close-btn" title="Fechar">‚úï</button>
    </div>
    <div class="drawer-search-bar">
      <input type="text" class="drawer-search" id="ep-filter" placeholder="Filtrar epis√≥dios..." oninput="filterEpisodes(this.value)">
    </div>
    <div class="drawer-body" id="drawer-body">
      <div class="state-box" style="padding:40px 20px;">
        <div class="spin"></div>
        <p style="margin-top:16px; font-size:13px;">Buscando epis√≥dios...</p>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="item-details-page">
    <div class="container">

      <!-- API CONFIG -->
      <div class="row" style="padding-top: 50px;">
        <div class="col-lg-12">
          <div class="api-config-banner">
            <div>
              <p><span>üîë Credenciais Podcast Index</span></p>
              <p style="font-size:12px; margin-top:4px;">Insira sua API Key e Secret do
                <a href="https://podcastindex.org" target="_blank" style="color:var(--amber);">podcastindex.org</a> (gratuito)
              </p>
            </div>
            <div class="config-inputs">
              <input type="text"     class="config-input" id="cfg-key"    placeholder="API Key"    autocomplete="off">
              <input type="password" class="config-input" id="cfg-secret" placeholder="API Secret" autocomplete="off">
              <button class="config-save-btn" onclick="saveCredentials()">Salvar</button>
            </div>
            <span id="cfg-status" style="font-size:12px; color:var(--muted);"></span>
          </div>
        </div>
      </div>

      <!-- SEARCH -->
      <div class="row">
        <div class="col-lg-12 search-area" style="padding-top:0;">
          <div class="section-heading">
            <div class="line-dec"></div>
            <h3>Encontre um Podcast</h3>
          </div>
          <div class="search-wrap">
            <input type="text" class="search-input" id="podcast-search"
              placeholder="Ex: Lex Fridman, Huberman Lab, Tecnologia..."
              onkeydown="if(event.key==='Enter') searchPodcasts()">
            <button class="search-btn" id="search-btn" onclick="searchPodcasts()">Buscar ‚Üí</button>
          </div>
          <div id="search-status" style="font-size:13px; color:var(--muted); margin-top:14px; min-height:20px;"></div>
          <div id="podcast-results"></div>
        </div>
      </div>

      <!-- NEWS FEED -->
      <div class="row" id="news-feed-section" style="padding-top:20px; display:none;">
        <div class="col-lg-12">
          <hr class="divider">
          <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:8px;">
            <div class="section-heading" style="margin-bottom:0;">
              <div class="line-dec"></div>
              <h3>Links dos Epis√≥dios</h3>
            </div>
            <button class="debug-toggle" onclick="toggleDebug()">üõ† Debug</button>
          </div>
          <p style="color:var(--muted); font-size:14px; margin-bottom:16px;">
            Clique em um epis√≥dio na gaveta para extrair os links da descri√ß√£o.
          </p>
          <div class="debug-panel" id="debug-panel"></div>
          <div style="margin-bottom:30px;"></div>
          <div id="episodes-content"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- VENDOR JS -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
  // =========================================================
  //  STATE
  // =========================================================
  let API_KEY     = localStorage.getItem('pi_key')    || '';
  let API_SECRET  = localStorage.getItem('pi_secret') || '';
  let allEpisodes    = [];
  let selectedPodcast = null;
  let loadedEpisodes  = {};   // epId  -> links[]
  let episodeCache    = {};   // epId  -> full episode object

  if (API_KEY)    document.getElementById('cfg-key').value    = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  if (API_SECRET) document.getElementById('cfg-secret').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  if (API_KEY && API_SECRET) document.getElementById('cfg-status').textContent = '‚úì Credenciais salvas';

  // =========================================================
  //  DEBUG
  // =========================================================
  function dbg(msg, type) {
    const panel = document.getElementById('debug-panel');
    const d = document.createElement('div');
    d.className = 'debug-line' + (type ? ' ' + type : '');
    d.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
    panel.appendChild(d);
    panel.scrollTop = panel.scrollHeight;
    console.log('[PodcastRadar]', msg);
  }
  function toggleDebug() {
    document.getElementById('debug-panel').classList.toggle('visible');
  }

  // =========================================================
  //  CREDENTIALS
  // =========================================================
  function saveCredentials() {
    const k = document.getElementById('cfg-key').value.trim();
    const s = document.getElementById('cfg-secret').value.trim();
    if (!k || !s || k === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') { showToast('Insira suas credenciais v√°lidas.'); return; }
    API_KEY = k; API_SECRET = s;
    localStorage.setItem('pi_key', k);
    localStorage.setItem('pi_secret', s);
    document.getElementById('cfg-status').textContent = '‚úì Credenciais salvas';
    showToast('‚úì Credenciais salvas com sucesso!');
  }

  // =========================================================
  //  AUTH  ‚Üê CORRE√á√ÉO PRINCIPAL
  //  O header correto √© X-Auth-Hash, n√£o "Authorization"
  // =========================================================
  async function sha1(str) {
    const buf  = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-1', buf);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  async function getAuthHeaders() {
    if (!API_KEY || !API_SECRET) throw new Error('NO_CREDENTIALS');
    const epoch = Math.floor(Date.now() / 1000).toString();
    const hash  = await sha1(API_KEY + API_SECRET + epoch);
    return {
      'X-Auth-Key':  API_KEY,
      'X-Auth-Date': epoch,
      'Authorization': hash,        // ‚Üê CORRETO (o bug era "Authorization" neste campo)
      'User-Agent':  'PodcastRadar/1.0'
    };
  }

  async function piGet(endpoint) {
    dbg('GET ' + endpoint);
    const headers = await getAuthHeaders();
    const res = await fetch('https://api.podcastindex.org/api/1.0' + endpoint, { headers });
    dbg('HTTP ' + res.status, res.ok ? 'ok' : 'err');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return res.json();
  }

  // =========================================================
  //  SEARCH PODCASTS
  // =========================================================
  async function searchPodcasts() {
    const q = document.getElementById('podcast-search').value.trim();
    if (!q) return;
    if (!API_KEY || !API_SECRET) {
      showToast('‚ö†Ô∏è Configure suas credenciais primeiro!');
      document.getElementById('cfg-key').focus();
      return;
    }

    const btn = document.getElementById('search-btn');
    btn.disabled = true; btn.textContent = '‚è≥';
    document.getElementById('search-status').textContent = 'Buscando podcasts...';
    document.getElementById('podcast-results').innerHTML = loadingSkeletonGrid(6);

    try {
      const data  = await piGet('/search/byterm?q=' + encodeURIComponent(q) + '&max=18');
      const feeds = data.feeds || [];

      document.getElementById('search-status').textContent =
        feeds.length ? feeds.length + ' podcast(s) encontrado(s)' : 'Nenhum resultado encontrado.';

      if (!feeds.length) {
        document.getElementById('podcast-results').innerHTML =
          '<div style="grid-column:1/-1;"><div class="state-box"><div class="state-icon">üéôÔ∏è</div><div class="state-title">Nenhum podcast encontrado</div><div class="state-msg">Tente outro termo de busca.</div></div></div>';
        return;
      }
      document.getElementById('podcast-results').innerHTML = feeds.map(f => podcastCardHtml(f)).join('');
    } catch (e) {
      const msg = e.message === 'NO_CREDENTIALS' ? 'Configure suas credenciais primeiro!' : 'Erro: ' + e.message;
      document.getElementById('search-status').textContent = '‚ö†Ô∏è ' + msg;
      document.getElementById('podcast-results').innerHTML = '';
      dbg(e.message, 'err');
    } finally {
      btn.disabled = false; btn.textContent = 'Buscar ‚Üí';
    }
  }

  function podcastCardHtml(f) {
    const thumb  = f.artwork || f.image || 'assets/images/current-01.jpg';
    const author = esc(f.author || f.ownerName || 'Desconhecido');
    const count  = f.episodeCount ? f.episodeCount + ' epis√≥dios' : '';
    const title  = esc(f.title || 'Sem t√≠tulo');
    const safeThumb  = esc(thumb);
    const safeTitle  = title.replace(/'/g, "\\'");
    const safeAuthor = author.replace(/'/g, "\\'");
    const safeImg    = safeThumb.replace(/'/g, "\\'");
    return '<div class="podcast-card" onclick="selectPodcast(' + f.id + ', \'' + safeTitle + '\', \'' + safeAuthor + '\', \'' + safeImg + '\')">'
      + '<img src="' + safeThumb + '" class="podcast-thumb" alt="" onerror="this.src=\'assets/images/current-01.jpg\'">'
      + '<div class="podcast-info">'
      + '<div class="podcast-title">' + title + '</div>'
      + '<div class="podcast-author">' + author + '</div>'
      + (count ? '<div class="podcast-ep-count">' + count + '</div>' : '')
      + '</div></div>';
  }

  // =========================================================
  //  DRAWER ‚Äî SELECT PODCAST & LOAD EPISODES
  //  Usa fulltext=true para j√° trazer description no listing
  // =========================================================
  async function selectPodcast(feedId, name, author, thumb) {
    selectedPodcast = { feedId, name, author, thumb };
    episodeCache    = {};

    document.querySelectorAll('.podcast-card').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');

    document.getElementById('drawer-name').textContent   = name;
    document.getElementById('drawer-author').textContent = author;
    const dThumb = document.getElementById('drawer-thumb');
    dThumb.src = thumb;
    dThumb.onerror = function() { this.src = 'assets/images/current-01.jpg'; };
    document.getElementById('ep-filter').value = '';
    document.getElementById('drawer-overlay').classList.add('open');
    document.getElementById('episode-drawer').classList.add('open');
    document.body.style.overflow = 'hidden';

    document.getElementById('drawer-body').innerHTML =
      '<div class="state-box" style="padding:40px 20px;">'
      + '<div class="spin"></div>'
      + '<p style="margin-top:16px;font-size:13px;">Carregando epis√≥dios...</p>'
      + '</div>';

    try {
      // fulltext=true faz o listing incluir a description completa de cada epis√≥dio
      const data = await piGet('/episodes/byfeedid?id=' + feedId + '&max=40&fulltext=true');
      allEpisodes = (data.items || []).sort((a, b) => b.datePublished - a.datePublished);
      allEpisodes.forEach(ep => { episodeCache[ep.id] = ep; });
      dbg(allEpisodes.length + ' epis√≥dios carregados (fulltext)', 'ok');
      renderEpisodeList(allEpisodes);
    } catch (e) {
      dbg('Erro ao carregar epis√≥dios: ' + e.message, 'err');
      document.getElementById('drawer-body').innerHTML =
        '<div class="state-box" style="padding:40px 20px;"><div class="state-icon">‚ö†Ô∏è</div><div class="state-title">Erro</div><div class="state-msg">' + e.message + '</div></div>';
    }
  }

  function renderEpisodeList(episodes) {
    if (!episodes.length) {
      document.getElementById('drawer-body').innerHTML =
        '<div class="state-box" style="padding:30px 20px;"><div class="state-msg">Nenhum epis√≥dio encontrado.</div></div>';
      return;
    }
    document.getElementById('drawer-body').innerHTML = episodes.map(ep => episodeItemHtml(ep)).join('');
  }

  function episodeItemHtml(ep) {
    const thumb = ep.image || ep.feedImage || (selectedPodcast && selectedPodcast.thumb) || 'assets/images/current-01.jpg';
    const date  = ep.datePublished ? formatDate(ep.datePublished * 1000) : '';
    const dur   = ep.duration ? formatDuration(ep.duration) : '';
    const title = esc(ep.title || 'Sem t√≠tulo');
    const safeThumb = esc(thumb).replace(/'/g, "\\'");
    const safeTitle = title.replace(/'/g, "\\'");
    return '<div class="episode-item" onclick="loadEpisodeLinks(' + ep.id + ', \'' + safeTitle + '\', \'' + safeThumb + '\', ' + (ep.datePublished || 0) + ')">'
      + '<img src="' + esc(thumb) + '" class="episode-thumb" alt="" onerror="this.src=\'assets/images/current-01.jpg\'">'
      + '<div class="episode-meta">'
      + '<div class="episode-title-text">' + title + '</div>'
      + (date ? '<div class="episode-date">üìÖ ' + date + '</div>' : '')
      + (dur  ? '<div class="episode-duration">‚è± ' + dur + '</div>' : '')
      + '</div>'
      + '<span class="episode-arrow">‚Ä∫</span>'
      + '</div>';
  }

  function filterEpisodes(q) {
    const filtered = q
      ? allEpisodes.filter(e => (e.title || '').toLowerCase().includes(q.toLowerCase()))
      : allEpisodes;
    renderEpisodeList(filtered);
  }

  // =========================================================
  //  CLOSE DRAWER
  // =========================================================
  document.getElementById('drawer-close-btn').onclick = closeDrawer;
  document.getElementById('drawer-overlay').onclick   = closeDrawer;
  function closeDrawer() {
    document.getElementById('episode-drawer').classList.remove('open');
    document.getElementById('drawer-overlay').classList.remove('open');
    document.body.style.overflow = '';
  }
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeDrawer(); });

  // =========================================================
  //  LOAD EPISODE LINKS
  // =========================================================
  async function loadEpisodeLinks(epId, epTitle, epThumb, datePublished) {
    closeDrawer();
    document.getElementById('news-feed-section').style.display = 'block';

    if (loadedEpisodes[epId]) { scrollToEpisode(epId); return; }

    const containerId     = 'ep-section-' + epId;
    const episodesContent = document.getElementById('episodes-content');

    if (!document.getElementById(containerId)) {
      var calDay2 = datePublished ? new Date(datePublished*1000).getDate() : '‚Äî';
      var calMon2 = datePublished ? new Date(datePublished*1000).toLocaleDateString('pt-BR',{month:'short'}).replace('.','').toUpperCase() : '';
      var dateStr2 = datePublished ? formatDate(datePublished * 1000) : '‚Äî';
      episodesContent.insertAdjacentHTML('afterbegin',
        '<div class="episode-section" id="' + containerId + '">'
        + '<div class="episode-section-header">'
        +   '<div class="ep-bar"></div>'
        +   '<div class="ep-cal"><div class="ep-cal-top"><span>' + calMon2 + '</span></div><div class="ep-cal-day">' + calDay2 + '</div></div>'
        +   '<div class="episode-section-meta">'
        +     '<div class="episode-section-title">' + dateStr2 + '</div>'
        +     '<span class="episode-link-count">Extraindo...</span>'
        +   '</div>'
        + '</div>'
        + '<div style="display:flex;gap:12px;align-items:center;padding:30px 0;color:var(--muted);font-size:14px;">'
        + '<div class="spin"></div> Extraindo links da descri√ß√£o do epis√≥dio...'
        + '</div>'
        + '</div>');
    }

    setTimeout(function() { scrollToEpisode(epId); }, 100);

    try {
      // ‚îÄ‚îÄ Estrat√©gia 1: cache do listing (fulltext=true j√° traz description) ‚îÄ‚îÄ
      let descRaw = '';
      const cached = episodeCache[epId];
      if (cached) {
        descRaw = cached.description || cached.content || cached.contentEncoded || cached.summary || '';
        dbg('Cache: ' + descRaw.length + ' chars de descri√ß√£o', descRaw.length > 10 ? 'ok' : 'warn');
      }

      // ‚îÄ‚îÄ Estrat√©gia 2: busca individual se o cache veio vazio ‚îÄ‚îÄ
      if (!descRaw || descRaw.length < 10) {
        dbg('Fallback: chamando /episodes/byid?id=' + epId + '&fulltext=true', 'warn');
        try {
          const data = await piGet('/episodes/byid?id=' + epId + '&fulltext=true');
          const ep   = data.episode || {};
          descRaw = ep.description || ep.content || ep.contentEncoded || ep.summary || ep.link || '';
          dbg('/byid retornou ' + descRaw.length + ' chars', descRaw.length > 10 ? 'ok' : 'err');
        } catch (fetchErr) {
          dbg('/byid falhou: ' + fetchErr.message, 'err');
        }
      }

      // ‚îÄ‚îÄ Extra√ß√£o de links ‚îÄ‚îÄ
      const links = extractLinks(descRaw);
      dbg('Links extra√≠dos: ' + links.length, links.length ? 'ok' : 'warn');

      loadedEpisodes[epId] = links;
      renderEpisodeSection(epId, epTitle, epThumb, datePublished, links);
      showToast(links.length ? '‚úì ' + links.length + ' link(s) extra√≠do(s)' : '‚ö†Ô∏è Nenhum link encontrado na descri√ß√£o');

    } catch (e) {
      dbg('Erro geral: ' + e.message, 'err');
      var sec = document.getElementById(containerId);
      if (sec) sec.innerHTML =
        '<div class="state-box"><div class="state-icon">‚ö†Ô∏è</div>'
        + '<div class="state-title">Erro ao carregar epis√≥dio</div>'
        + '<div class="state-msg">' + esc(e.message) + '</div></div>';
    }
  }

  // =========================================================
  //  LINK EXTRACTION
  // =========================================================
  function extractLinks(rawContent) {
    if (!rawContent) return [];

    const results = [];
    const seen    = new Set();

    // ‚îÄ‚îÄ Passo 1: Parse HTML ‚Üí <a href> ‚îÄ‚îÄ
    var parser = new DOMParser();
    var doc    = parser.parseFromString(rawContent, 'text/html');

    doc.querySelectorAll('a[href]').forEach(function(a) {
      var href  = (a.getAttribute('href') || '').trim();
      var label = (a.textContent || a.title || '').trim();
      if (!href || seen.has(href)) return;
      if (!isNewsUrl(href)) { dbg('Skip (blocklist): ' + href, 'warn'); return; }
      seen.add(href);
      results.push({ url: href, title: label || slugToTitle(href), source: extractDomain(href), desc: getSurroundingText(doc, a) });
    });

    dbg('Links via <a>: ' + results.length);

    // ‚îÄ‚îÄ Passo 2: Varredura de texto plano por URLs brutas ‚îÄ‚îÄ
    var urlRegex = /https?:\/\/([\w-]+\.)+[\w]{2,}(\/[\w\-._%~:/?#[\]@!$&'()*+,;=%]*)?/g;
    var texts    = [(doc.body && doc.body.innerText) || '', rawContent];
    texts.forEach(function(txt) {
      var m;
      while ((m = urlRegex.exec(txt)) !== null) {
        var href = m[0].replace(/[.,;:'")\]>]+$/, '');
        if (seen.has(href)) return;
        if (!isNewsUrl(href)) return;
        seen.add(href);
        results.push({ url: href, title: slugToTitle(href), source: extractDomain(href), desc: '' });
      }
    });

    dbg('Total links ap√≥s varredura: ' + results.length);
    return results;
  }

  var SKIP_DOMAINS = new Set([
    'spotify.com','podcasts.apple.com','anchor.fm','buzzsprout.com',
    'podcastindex.org','listennotes.com','podchaser.com','pod.link',
    'overcast.fm','pocketcasts.com','castro.fm','player.fm',
    'podcastaddict.com','pocket-casts.com','breaker.audio',
    'twitter.com','x.com','instagram.com','facebook.com','fb.com',
    'youtube.com','youtu.be','tiktok.com','linkedin.com','reddit.com',
    'patreon.com','paypal.com','ko-fi.com','buy.stripe.com','substack.com',
    'amzn.to','amazon.com','audible.com','apple.com',
    'linktr.ee','beacons.ai','bio.link',
    'mailchimp.com','convertkit.com',
  ]);

  function isNewsUrl(url) {
    try {
      var u = new URL(url);
      if (u.protocol !== 'http:' && u.protocol !== 'https:') return false;
      var domain = u.hostname.replace(/^www\./, '');
      if (SKIP_DOMAINS.has(domain)) return false;
      if (u.pathname.replace(/\//g, '').length < 3) return false;
      return true;
    } catch(e) { return false; }
  }

  function extractDomain(url) {
    try { return new URL(url).hostname.replace(/^www\./, ''); }
    catch(e) { return url; }
  }

  function slugToTitle(url) {
    try {
      var parts = new URL(url).pathname.split('/').filter(Boolean);
      var slug  = parts[parts.length - 1] || parts[parts.length - 2] || '';
      return slug.replace(/[-_]/g,' ').replace(/\.[a-z0-9]+$/,'').replace(/\b\w/g, function(c){ return c.toUpperCase(); }).trim() || extractDomain(url);
    } catch(e) { return url; }
  }

  function getSurroundingText(doc, anchor) {
    var parent = anchor.closest('p, li, blockquote, div, td');
    if (!parent) return '';
    var txt = (parent.textContent || '').trim();
    var at  = (anchor.textContent || '').trim();
    if (txt.length <= at.length + 5) return '';
    return txt.substring(0, 180).trim() + (txt.length > 180 ? '‚Ä¶' : '');
  }

  // =========================================================
  //  RENDER EPISODE SECTION
  // =========================================================
  function renderEpisodeSection(epId, epTitle, epThumb, datePublished, links) {
    var section = document.getElementById('ep-section-' + epId);
    if (!section) return;

    var carouselId = 'carousel-' + epId;
    var cardsHtml  = links.length
      ? links.map(function(l) { return newsCardHtml(l); }).join('')
      : '<div class="carousel-slide"><div class="state-box" style="padding:30px 20px;text-align:left;">'
        + '<div class="state-icon">üîç</div>'
        + '<div class="state-title">Sem links encontrados</div>'
        + '<div class="state-msg">Este epis√≥dio n√£o tem links externos na descri√ß√£o. Ative o painel Debug para detalhes.</div>'
        + '</div></div>';

    // Extrai dia e m√™s abreviado para o √≠cone de calend√°rio
    var calDay = '‚Äî', calMon = '';
    if (datePublished) {
      var d = new Date(datePublished * 1000);
      calDay = d.getDate();
      calMon = d.toLocaleDateString('pt-BR', { month: 'short' }).replace('.','').toUpperCase();
    }
    var dateStr   = datePublished ? formatDate(datePublished * 1000) : '‚Äî';
    var countText = links.length ? '(' + links.length + ' links)' : '';

    section.innerHTML =
      // ‚îÄ‚îÄ Header id√™ntico ao screenshot ‚îÄ‚îÄ
      '<div class="episode-section-header">'
      // barra roxa
      + '<div class="ep-bar"></div>'
      // √≠cone calend√°rio
      + '<div class="ep-cal">'
      +   '<div class="ep-cal-top"><span>' + calMon + '</span></div>'
      +   '<div class="ep-cal-day">' + calDay + '</div>'
      + '</div>'
      // data + count
      + '<div class="episode-section-meta">'
      +   '<div class="episode-section-title">' + dateStr + '</div>'
      +   (links.length ? '<span class="episode-link-count">' + countText + '</span>' : '')
      + '</div>'
      // setas √† direita
      + '<div class="carousel-header-nav">'
      +   '<button class="carousel-header-btn prev-btn" onclick="scrollCarousel(\'' + carouselId + '\',-1)" title="Anterior">&#8249;</button>'
      +   '<button class="carousel-header-btn next-btn" onclick="scrollCarousel(\'' + carouselId + '\',1)" title="Pr√≥ximo">&#8250;</button>'
      + '</div>'
      + '</div>'
      // ‚îÄ‚îÄ Carrossel ‚îÄ‚îÄ
      + '<div class="news-carousel-wrap">'
      + '<div class="news-carousel-inner" id="' + carouselId + '">' + cardsHtml + '</div>'
      + '</div>';
  }

  function newsCardHtml(link) {
    var title  = esc(link.title  || link.source);
    var desc   = esc(link.desc   || '');
    var source = '@' + esc((link.source || '').toUpperCase());
    var url    = esc(link.url);
    var letter = (link.source || '?').charAt(0).toUpperCase();
    // Tag baseada no dom√≠nio
    var tag = guessTag(link.source, link.title);

    return '<div class="carousel-slide">'
      + '<div class="news-card" onclick="window.open(\'' + url + '\',\'_blank\')">'
      // √°rea da imagem (placeholder com quadradinho branco via CSS ::after)
      + '<div class="news-card-img-wrap no-img"><span>' + letter + '</span></div>'
      + '<div class="news-card-body">'
      +   '<div class="news-card-title">' + title + '</div>'
      +   '<span class="news-card-source">' + source + '</span>'
      +   (desc ? '<p class="news-card-desc">' + desc + '</p>' : '')
      +   '<span class="news-card-tag">' + tag + '</span>'
      + '</div>'
      + '</div></div>';
  }

  // Adivinha a tag da not√≠cia a partir do dom√≠nio/t√≠tulo
  function guessTag(source, title) {
    var text = ((source || '') + ' ' + (title || '')).toLowerCase();
    if (/nvidia|gpu|chip|amd|intel|hardware/.test(text)) return 'HARDWARE';
    if (/hack|cyber|security|seguran√ßa|vuln/.test(text)) return 'CYBER';
    if (/gpt|openai|gemini|llm|claude|ia|ai|anthropic|deepmind/.test(text)) return 'AI';
    if (/oil|gas|petro|energy|energia/.test(text)) return 'ENERGY';
    if (/finance|invest|market|stock|crypto/.test(text)) return 'FINANCE';
    return 'TECH';
  }

  // =========================================================
  //  CAROUSEL NAV
  // =========================================================
  function scrollCarousel(id, dir) {
    var el = document.getElementById(id);
    if (el) el.scrollBy({ left: dir * 320, behavior: 'smooth' });
  }

  // =========================================================
  //  HELPERS
  // =========================================================
  function scrollToEpisode(epId) {
    var el = document.getElementById('ep-section-' + epId);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  function formatDate(ts) {
    return new Date(ts).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
  }
  function formatDuration(secs) {
    if (!secs) return '';
    var h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60);
    return h ? h + 'h ' + m + 'min' : m + 'min';
  }
  function esc(str) {
    return String(str || '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 3500);
  }
  function loadingSkeletonGrid(n) {
    var card = '<div style="background:var(--surface);border-radius:16px;padding:18px;display:flex;gap:14px;">'
      + '<div class="skeleton sk-block"></div>'
      + '<div style="flex:1"><div class="skeleton sk-line"></div><div class="skeleton sk-line short"></div>'
      + '<div class="skeleton sk-line" style="width:40%;margin-top:12px;"></div></div></div>';
    var out = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;margin-top:30px;grid-column:1/-1;">';
    for (var i = 0; i < n; i++) out += card;
    return out + '</div>';
  }
  </script>
</body>
</html>