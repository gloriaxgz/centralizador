<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="author" content="templatemo">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <title>Transcritor de Podcasts</title>
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />
</head>

<body>

  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
      <span class="dot"></span>
      <div class="dots"><span></span><span></span><span></span></div>
    </div>
  </div>

  <header class="header-area header-sticky">
    <div class="container">
      <div class="row"><div class="col-12">
        <nav class="main-nav">
          <a href="index.html" class="logo"><img src="assets/images/logo.png" alt=""></a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="create.html" class="active">Transcritor de Podcast</a></li>
            <li><a href="details.html">News Radar</a></li>
            <li><a href="table.html">Newsboard</a></li>
          </ul>
          <a class='menu-trigger'><span>Menu</span></a>
        </nav>
      </div></div>
    </div>
  </header>
<div id="drawer-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;z-index:9998;"></div>
<div id="episode-drawer" style="position:fixed;top:0;right:-400px;width:400px;height:100%;background:#1f2124;z-index:9999;transition:0.3s;padding:20px;overflow-y:auto;border-left:1px solid #444;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h4 style="color:white;">EpisÃ³dios</h4>
        <button onclick="closeDrawer()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">âœ•</button>
    </div>
    <div id="drawer-body"></div>
</div>

<div class="container" style="margin-top:20px;">
    <div style="background:#282b2f;padding:15px;border-radius:15px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;">
        <input type="text" id="cfg-key" placeholder="PodcastIndex Key" style="background:#1f2124;color:white;border:1px solid #444;padding:8px;border-radius:10px;">
        <input type="password" id="cfg-secret" placeholder="PodcastIndex Secret" style="background:#1f2124;color:white;border:1px solid #444;padding:8px;border-radius:10px;">
        <button onclick="saveCredentials()" class="orange-button" style="padding:8px 20px;">Salvar Chaves</button>
    </div>
</div>
  <div class="page-heading normal-space">
    <div class="container"><div class="row"><div class="col-lg-12">
      <h2>Transcritor de Podcasts</h2>
    </div></div></div>
  </div>

  <div class="item-details-page">
    <div class="container"><div class="row">

      <div class="col-lg-12">
    <div class="section-heading">
        <div class="line-dec"></div>
        <h2>Busque um Podcast ou Cole o Link</h2>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:30px;">
        <input type="text" id="podcast-search-input" placeholder="Pesquisar podcast (ex: Flow, Lex Fridman...)" 
               style="flex:1;background-color:#37393c;color:white;border:none;padding:15px;border-radius:20px;">
        <button onclick="searchPodcasts()" class="orange-button">Buscar Podcast</button>
    </div>
    <div id="podcast-results-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:15px;margin-bottom:40px;"></div>
</div>

      <div class="col-lg-12">
        <form id="transcription-form">
          <div class="row">
            <div class="col-lg-12">
              <fieldset>
                <label for="audio-url">Link Direto do Ãudio (.mp3)</label>
                <input type="text" id="audio-url" placeholder="https://exemplo.com/audio.mp3" required
                       style="background-color:#37393c;color:white;border:none;padding:15px;border-radius:20px;width:100%;margin-bottom:20px;">
              </fieldset>
            </div>
            <div class="col-lg-12">
              <fieldset>
                <button type="submit" id="form-submit" class="orange-button">Iniciar TranscriÃ§Ã£o</button>
              </fieldset>
            </div>
          </div>
        </form>
      </div>

      <!-- â”€â”€â”€ RESULTS â”€â”€â”€ -->
      <div class="col-lg-12" id="section-resultados" style="margin-top:50px;display:none;">

        <div class="section-heading">
          <div class="line-dec"></div>
          <h2>Sua <em>TranscriÃ§Ã£o</em></h2>
        </div>

        <div class="action-buttons">
          <button class="btn-toggle" id="toggle-transcricao">â–¼ Expandir Texto</button>
          <button class="btn-copy" id="copy-transcricao">Copiar TranscriÃ§Ã£o</button>
        </div>

        <div id="resultado-container" class="collapsed"
             style="background:#282b2f;padding:30px;border-radius:20px;color:white;border:1px solid #444;">
          <p id="texto-transcrito"></p>
        </div>

        <!-- â”€â”€â”€ TOPICS â”€â”€â”€ -->
        <div id="container-topicos" style="display:none;margin-top:50px;">
          <div class="section-heading">
            <div class="line-dec"></div>
            <h2>O que deseja <em>Resumir?</em></h2>
          </div>

          <div id="lista-topicos" class="topic-selection-card">
            <p style="color:white;text-align:center;">Analisando assuntos e gerando prÃ©vias robustas...</p>
          </div>

          <!-- Topic action buttons -->
          <div style="text-align:center;margin-top:30px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap;align-items:center;">
            <button id="btn-gerar-resumo-final" class="orange-button"
                    style="background-color:#275b68;border-color:#ffffff;">
              Gerar RelatÃ³rio Individualizado
            </button>

            <!-- NOVO: Enviar para Newsboard -->
            <a href="javascript:void(0)" id="btn-send-to-board"
               style="display:inline-flex;align-items:center;gap:8px;
                      padding:15px 30px;border-radius:40px;
                      background:transparent;border:2px solid #00ffcc;
                      color:#00ffcc;font-size:14px;font-weight:700;
                      cursor:pointer;text-decoration:none;transition:all .2s;">
              ğŸ“‹ Enviar TÃ³picos para Newsboard
            </a>
          </div>
        </div>

        <!-- â”€â”€â”€ FINAL REPORT â”€â”€â”€ -->
        <div id="resumo-wrapper" style="display:none;margin-top:50px;">
          <div class="section-heading">
            <div class="line-dec"></div>
            <h2>RelatÃ³rio <em>Executivo por TÃ³pico</em></h2>
          </div>
          <div class="action-buttons">
            <button class="btn-copy" id="copy-resumo">Copiar RelatÃ³rio Completo</button>
          </div>
          <div id="resultado-resumo"
               style="text-align:left;background:#1f2124;padding:40px;border-radius:20px;border:1px dashed #5d3cf2;color:#ddd;">
          </div>
        </div>

      </div>
      <!-- â”€â”€â”€ /RESULTS â”€â”€â”€ -->

    </div></div>
  </div>

  <!-- TOAST -->
  <div id="podcast-toast"
       style="position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(20px);
              background:#1c1e24;border:1px solid #00ffcc;color:#00ffcc;
              font-size:13px;font-weight:700;padding:12px 24px;border-radius:40px;
              opacity:0;pointer-events:none;transition:all .3s;z-index:9999;white-space:nowrap;">
  </div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/isotope.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/tabs.js"></script>
  <script src="assets/js/popup.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
  $(document).ready(function() {

    // â”€â”€ CONFIGURAÃ‡Ã•ES INICIAIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let API_KEY = localStorage.getItem('pi_key') || '';
    let API_SECRET = localStorage.getItem('pi_secret') || '';

    if (API_KEY) $('#cfg-key').val('â€¢â€¢â€¢â€¢â€¢â€¢');
    if (API_SECRET) $('#cfg-secret').val('â€¢â€¢â€¢â€¢â€¢â€¢');

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let toastTimer;
    function showToast(msg, color) {
        const t = document.getElementById('podcast-toast');
        t.textContent = msg;
        t.style.borderColor = color || '#00ffcc';
        t.style.color = color || '#00ffcc';
        t.style.opacity = '1';
        t.style.transform = 'translateX(-50%) translateY(0)';
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            t.style.opacity = '0';
            t.style.transform = 'translateX(-50%) translateY(20px)';
        }, 3000);
    }

    // â”€â”€ AUTH & CREDENTIALS PODCAST INDEX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.saveCredentials = function() {
        const k = $('#cfg-key').val().trim();
        const s = $('#cfg-secret').val().trim();
        if (!k || !s || k === 'â€¢â€¢â€¢â€¢â€¢â€¢') { showToast('Insira credenciais vÃ¡lidas.', '#ff4d6d'); return; }
        API_KEY = k; API_SECRET = s;
        localStorage.setItem('pi_key', k);
        localStorage.setItem('pi_secret', s);
        showToast('âœ“ Credenciais salvas com sucesso!');
    };

    async function getAuthHeaders() {
        if (!API_KEY || !API_SECRET) throw new Error('NO_CREDENTIALS');
        const epoch = Math.floor(Date.now() / 1000).toString();
        const txt = API_KEY + API_SECRET + epoch;
        const buf = new TextEncoder().encode(txt);
        const hashBuffer = await crypto.subtle.digest('SHA-1', buf);
        const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        return {
            'X-Auth-Key': API_KEY,
            'X-Auth-Date': epoch,
            'Authorization': hashHex,
            'User-Agent': 'PodcastRadar/1.0'
        };
    }

    // â”€â”€ BUSCA E SELEÃ‡ÃƒO DE PODCASTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.searchPodcasts = async function() {
        const q = $('#podcast-search-input').val().trim();
        if (!q) return;
        if (!API_KEY) { showToast('Configure as chaves primeiro!', '#ff4d6d'); return; }

        $('#podcast-results-grid').html('<p style="color:white; grid-column:1/-1; text-align:center;">ğŸ” Buscando podcasts...</p>');

        try {
            const headers = await getAuthHeaders();
            const res = await fetch(`https://api.podcastindex.org/api/1.0/search/byterm?q=${encodeURIComponent(q)}&max=6`, { headers });
            const data = await res.json();
            const feeds = data.feeds || [];

            if (feeds.length === 0) {
                $('#podcast-results-grid').html('<p style="color:white; grid-column:1/-1; text-align:center;">Nenhum resultado encontrado.</p>');
                return;
            }

            let html = '';
            feeds.forEach(f => {
                html += `
                <div class="podcast-card" onclick="loadEpisodes(${f.id})" style="cursor:pointer; background:#282b2f; padding:15px; border-radius:20px; text-align:center; transition: transform 0.2s;">
                    <img src="${f.artwork || f.image}" style="width:100%; border-radius:15px; margin-bottom:10px;" onerror="this.src='assets/images/current-01.jpg'">
                    <h6 style="color:white; font-size:13px; margin-bottom:0;">${f.title}</h6>
                </div>`;
            });
            $('#podcast-results-grid').html(html);
        } catch (e) {
            showToast('Erro na busca: ' + e.message, '#ff4d6d');
        }
    };

    window.loadEpisodes = async function(feedId) {
        $('#drawer-overlay').fadeIn();
        $('#episode-drawer').css('right', '0');
        $('#drawer-body').html('<div style="text-align:center; padding:40px;"><div class="spin"></div><p style="color:white; margin-top:15px;">Carregando episÃ³dios...</p></div>');

        try {
            const headers = await getAuthHeaders();
            const res = await fetch(`https://api.podcastindex.org/api/1.0/episodes/byfeedid?id=${feedId}&max=30`, { headers });
            const data = await res.json();
            const items = data.items || [];

            let html = '';
            items.forEach(ep => {
                const date = new Date(ep.datePublished * 1000).toLocaleDateString('pt-BR');
                html += `
                <div onclick="selectEpisode('${ep.enclosureUrl}')" style="padding:15px; border-bottom:1px solid #333; cursor:pointer; transition: background 0.2s;" onmouseover="this.style.background='#2d3035'" onmouseout="this.style.background='transparent'">
                    <small style="color:#00ffcc;">ğŸ“… ${date}</small>
                    <p style="color:white; margin:5px 0 0 0; font-size:14px; font-weight:500;">${ep.title}</p>
                </div>`;
            });
            $('#drawer-body').html(html || '<p style="color:white;">Nenhum episÃ³dio encontrado.</p>');
        } catch (e) {
            $('#drawer-body').html('<p style="color:white;">Erro ao carregar episÃ³dios.</p>');
        }
    };

    window.selectEpisode = function(url) {
        $('#audio-url').val(url);
        window.closeDrawer();
        showToast("âœ“ Link selecionado!");
        $('html, body').animate({ scrollTop: $('#transcription-form').offset().top - 100 }, 500);
    };

    window.closeDrawer = function() {
        $('#episode-drawer').css('right', '-400px');
        $('#drawer-overlay').fadeOut();
    };

    $('#drawer-overlay').on('click', window.closeDrawer);

    // â”€â”€ 1. TRANSCRIÃ‡ÃƒO (PYTHON API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#transcription-form').on('submit', function(e) {
        e.preventDefault();
        const linkAudio = $('#audio-url').val().trim();
        if (!linkAudio) { showToast('Insira uma URL vÃ¡lida.', '#ff4d6d'); return; }

        const $botao = $('#form-submit');
        $botao.html('<i class="fa fa-spinner fa-spin"></i> Processando Ãudio (Whisper)...').prop('disabled', true);

        $('#section-resultados').fadeIn();
        $('#texto-transcrito').text('Baixando e transcrevendo Ã¡udio... Isso pode levar alguns minutos para episÃ³dios longos.');
        $('#container-topicos, #resumo-wrapper').hide();

        $.ajax({
            url: '/api/transcribe',
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({ audioUrl: linkAudio }),
            success: function(response) {
                const texto = response.transcript;
                $('#texto-transcrito').text(texto);
                
                if (response.cached) {
                    showToast("ğŸš€ Recuperado do cache instantaneamente!");
                } else {
                    showToast("âœ… TranscriÃ§Ã£o finalizada!");
                }
                
                $botao.text('Iniciar Nova TranscriÃ§Ã£o').prop('disabled', false);
                extrairTopicosRobustos(texto);
            },
            error: function(err) {
                console.error('Erro na transcriÃ§Ã£o:', err);
                $('#texto-transcrito').text('Erro: ' + (err.responseJSON?.error || 'Falha na comunicaÃ§Ã£o com a API Python.'));
                $botao.text('Tentar Novamente').prop('disabled', false);
            }
        });
    });

    // â”€â”€ 2. EXTRAÃ‡ÃƒO DE TÃ“PICOS (CHAT GPT-4O) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function extrairTopicosRobustos(texto) {
        $('#container-topicos').fadeIn();
        $('#lista-topicos').html('<p style="color:white;text-align:center;"><i class="fa fa-cog fa-spin"></i> IA identificando temas estratÃ©gicos...</p>');

        $.ajax({
            url: '/api/chat',
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({
                messages: [{
                    role: 'system',
                    content: 'Analyze the transcript and identify 7 main topics. Ignore meta-talk about the podcast itself. For each topic: 1. Title (Professional). 2. A robust summary (3-5 sentences). Return ONLY a JSON array: [{"title": "...", "summary": "..."}]'
                }, {
                    role: 'user',
                    content: 'Transcript: ' + texto.substring(0, 18000)
                }],
                temperature: 0.3
            }),
            success: function(response) {
                try {
                    const content = response.content;
                    const cleanJson = content.replace(/```json|```/g, '');
                    const topicos = JSON.parse(cleanJson);

                    let html = '';
                    topicos.forEach(t => {
                        const searchLink = `https://www.google.com/search?q=${encodeURIComponent(t.title)}+news+ai+tech&tbm=nws`;
                        html += `
                            <label class="topic-item">
                                <input type="checkbox" name="podcast-topic" value="${t.title}" data-summary="${t.summary.replace(/"/g,'&quot;')}">
                                <div class="topic-content">
                                    <span class="topic-title">${t.title}</span>
                                    <span class="topic-desc">${t.summary}</span>
                                    <a href="${searchLink}" target="_blank" class="news-link"><i class="fa fa-external-link"></i> Ver notÃ­cias</a>
                                </div>
                            </label>`;
                    });
                    $('#lista-topicos').html(html);
                } catch(e) {
                    $('#lista-topicos').text('Erro ao processar tÃ³picos. Tente gerar o relatÃ³rio direto.');
                }
            }
        });
    }

    // â”€â”€ 3. RELATÃ“RIO FINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-gerar-resumo-final').on('click', function() {
        const selecionados = [];
        $("input[name='podcast-topic']:checked").each(function() { selecionados.push($(this).val()); });
        if (selecionados.length === 0) return alert('Selecione ao menos um tÃ³pico!');

        const $btn = $(this);
        $btn.text('â³ Gerando RelatÃ³rio...').prop('disabled', true);
        $('#resumo-wrapper').fadeIn();
        $('#resultado-resumo').html('Aguarde, consolidando anÃ¡lise tÃ©cnica...');

        $.ajax({
            url: '/api/chat',
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            data: JSON.stringify({
                messages: [{
                    role: 'user',
                    content: `Summarize the following transcript. Sections for: ${selecionados.join(', ')}. Format with <h3>, <b> and <br>. Transcript: ${$('#texto-transcrito').text().substring(0, 20000)}`
                }],
                temperature: 0.2
            }),
            success: function(response) {
                $('#resultado-resumo').html(response.content.replace(/\n/g, '<br>'));
                $btn.text('Gerar RelatÃ³rio Individualizado').prop('disabled', false);
                $('html,body').animate({ scrollTop: $('#resumo-wrapper').offset().top - 50 }, 600);
            }
        });
    });

    // â”€â”€ 4. NEWSBOARD & AUXILIARES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-send-to-board').on('click', async function() {
        const selecionados = [];
        $("input[name='podcast-topic']:checked").each(function() {
            selecionados.push({ title: $(this).val(), notes: $(this).data('summary') || '', source: 'Podcast', url: '', tags: 'Podcast' });
        });

        if (selecionados.length === 0) return alert('Selecione um tÃ³pico.');

        try {
            const res = await fetch('/api/newsboard?action=pending', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ articles: selecionados }),
            });
            if (res.ok) {
                showToast(`âœ“ ${selecionados.length} itens enviados ao Newsboard`);
                window.open('table.html', '_blank');
            }
        } catch(e) { showToast('Erro ao enviar.', '#ff4d6d'); }
    });

    $('#toggle-transcricao').on('click', function() {
        const container = $('#resultado-container');
        container.toggleClass('collapsed expanded');
        $(this).text(container.hasClass('expanded') ? 'â–² Recolher Texto' : 'â–¼ Expandir Texto');
    });

    $('.btn-copy').on('click', function() {
        const target = $(this).attr('id') === 'copy-transcricao' ? '#texto-transcrito' : '#resultado-resumo';
        navigator.clipboard.writeText($(target).text()).then(() => {
            const oldTxt = $(this).text();
            $(this).text('âœ“ Copiado!');
            setTimeout(() => $(this).text(oldTxt), 2000);
        });
    });
});
  </script>
</body>
</html>