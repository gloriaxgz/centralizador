<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content="templatemo">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <title>News Radar - Centralizado</title>
  
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/css/news-carousel.css">
</head>

<body>

  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner"><span class="dot"></span><div class="dots"><span></span><span></span><span></span></div></div>
  </div>

  <header class="header-area header-sticky">
    <div class="container">
      <div class="row"><div class="col-12">
        <nav class="main-nav">
          <a href="index.html" class="logo"><img src="assets/images/logo.png" alt=""></a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="create.html">Transcritor de Podcast</a></li>
            <li><a href="details.html" class="active">News Radar</a></li>
          </ul>
          <a class='menu-trigger'><span>Menu</span></a>
        </nav>
      </div></div>
    </div>
  </header>

  <div class="page-heading normal-space">
    <div class="container"><div class="row"><div class="col-lg-12">
      <h2>Daily Tech News Curator</h2>
      <p style="color: #7453f8; font-weight: bold;">Sincronizado com Banco de Dados Global</p>
    </div></div></div>
  </div>

  <div class="item-details-page">
    <div class="container"><div class="row">

      <div class="col-lg-12">
        <div class="section-heading">
          <div class="line-dec"></div>
          <h2>Tech <em>Intelligence Radar</em></h2>
        </div>
      </div>

      <div class="col-lg-12 text-center" style="margin-bottom: 40px;">
        <div class="main-button">
          <a href="javascript:void(0)" id="btn-refresh-news" style="background-color: #00ffcc; border-color: #00ffcc; color: #333; font-weight: bold; padding: 10px 25px;">
             Atualizar Not√≠cias Agora
          </a>
        </div>
        <p id="refresh-status" style="color: #00ffcc; font-size: 12px; margin-top: 10px; display: none;">Sincronizando com GNews e atualizando banco global...</p>
      </div>

      <div class="col-lg-12" id="news-feed-container">
        <h5 class="text-center" style="color:white;padding:50px;">Buscando as not√≠cias mais recentes no banco...</h5>
      </div>

      <div class="col-lg-12 text-center" style="margin-top:30px;">
        <div id="load-more-container" style="display:none;">
          <div class="border-button">
            <a href="javascript:void(0)" id="btn-load-more">Mostrar dias anteriores</a>
          </div>
        </div>
        <div class="main-button" style="margin-top:30px;">
          <a href="javascript:void(0)" id="btn-generate-report"
             style="display:none;background-color:#7453f8;border-color:#7453f8;padding:15px 30px;">
            ‚ú® Generate AI Report (Selected: <span id="count">0</span>)
          </a>
        </div>
      </div>

      <div class="col-lg-12" id="summary-section" style="display:none;margin-top:60px;">
        <div class="section-heading">
          <div class="line-dec"></div>
          <h2>AI <em>Executive Summary</em></h2>
        </div>
        <div id="summary-output"></div>
      </div>

    </div></div>
  </div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
  // ================= ESTADO GLOBAL =================
  let newsByDate = {};
  let selectedArticles = [];
  let displayedDatesCount = 0;
  const DATES_PER_LOAD = 2;

  $(document).ready(async () => {
    await carregarNoticiasGlobais();
  });

  // ================= CARREGAMENTO VIA API + KV =================
  async function carregarNoticiasGlobais(force = false) {
    try {
      if(force) {
        $('#refresh-status').fadeIn();
      }

      // Adiciona o par√¢metro ?force=true se o bot√£o foi clicado
      const url = force ? '/api/news?force=true' : '/api/news';
      
      const response = await fetch(url);
      const articles = await response.json();

      if (!articles || articles.length === 0) {
        $('#news-feed-container').html('<h5 class="text-center" style="color:white;padding:50px;">Nenhuma not√≠cia sincronizada no momento.</h5>');
        return;
      }

      // Limpa o estado atual para nova renderiza√ß√£o
      newsByDate = {};
      displayedDatesCount = 0;
      selectedArticles = [];
      $('#count').text('0');
      $('#btn-generate-report').hide();

      articles.forEach(art => {
        const dt = new Date(art.publishedAt);
        const dateKey = dt.toLocaleDateString('pt-BR');
        if (!newsByDate[dateKey]) newsByDate[dateKey] = [];
        newsByDate[dateKey].push(art);
      });

      $('#news-feed-container').empty();
      renderNextBatch();
      $('#refresh-status').fadeOut();

    } catch (e) {
      console.error('Erro ao carregar not√≠cias:', e);
      $('#news-feed-container').html('<h5 class="text-center" style="color:#ff6b6b;padding:50px;">Erro ao sincronizar com o banco de dados central.</h5>');
      $('#refresh-status').fadeOut();
    }
  }

  // ================= EVENTO DO BOT√ÉO ATUALIZAR =================
  $('#btn-refresh-news').on('click', async function() {
    const $btn = $(this);
    $btn.css('pointer-events', 'none').css('opacity', '0.5').text('‚è≥ Atualizando...');
    
    await carregarNoticiasGlobais(true);
    
    $btn.css('pointer-events', 'auto').css('opacity', '1').text('üîÑ Atualizar Not√≠cias Agora');
  });

  // ================= RENDERIZA√á√ÉO EM LOTES =================
  async function renderNextBatch() {
    const container = $('#news-feed-container');
    const sortedDates = getSortedDates();
    
    const batch = sortedDates.slice(displayedDatesCount, displayedDatesCount + DATES_PER_LOAD);

    for (const date of batch) {
      const safeId = `carousel-${date.replace(/\//g,'-')}`;
      const articles = newsByDate[date];
      const cardsHtml = await buildCards(articles);

      const sectionHtml = `
        <div class="carousel-date-row" style="margin-bottom:50px;">
          <h4 class="date-section-header" style="color:#fff; margin-bottom:20px; font-size:20px;">
            üìÖ ${date} <span style="font-size:14px; color:#7453f8;">(${articles.length} not√≠cias)</span>
          </h4>
          <div id="${safeId}" class="owl-carousel owl-theme news-carousel">
            ${cardsHtml}
          </div>
        </div>`;
      
      container.append(sectionHtml);
      initOwlCarousel($(`#${safeId}`));
    }

    displayedDatesCount += batch.length;
    syncLoadMoreButton();
  }

  function initOwlCarousel($el) {
    $el.owlCarousel({
      items: 3, margin: 30, dots: false, nav: true,
      navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
      responsive: { 0: { items: 1 }, 768: { items: 2 }, 1200: { items: 3 } }
    });
  }

  async function buildCards(articles) {
    let html = '';
    // Ordena por data (mais recente primeiro)
    articles.sort((a,b) => new Date(b.publishedAt) - new Date(a.publishedAt));

    for (const art of articles) {
      const tags = generateSmartTags(art.title, art.description);
      const title = (art.title || 'Sem t√≠tulo').replace(/"/g,'&quot;');
      const desc = (art.description || 'Sem descri√ß√£o').replace(/"/g,'&quot;');
      const img = art.image || 'assets/images/current-01.jpg';
      const source = art.source?.name || 'News';
      const urlNoticia = art.url || '#';

      html += `
        <div class="item">
          <div class="news-item-card">
            <input type="checkbox" class="news-checkbox" data-title="${title}" data-desc="${desc}" data-source="${source}">
            <div class="news-image-container">
              <img src="${img}" alt="News" loading="lazy" onerror="this.src='assets/images/current-01.jpg'">
            </div>
            <div class="news-content-area">
              <h4>${art.title || 'Sem T√≠tulo'}</h4>
              
              <a href="${urlNoticia}" target="_blank" class="source-link" title="Ler no site original">
                <span class="source-tag">@${source}</span>
              </a>

              <p>${art.description || 'Clique para ler a mat√©ria completa.'}</p>
              <div class="tags-list">${tags}</div>
            </div>
          </div>
        </div>`;
    }
    return html;
  }

  function generateSmartTags(title, desc) {
    const text = (title + " " + desc).toLowerCase();
    let foundTags = [];
    const taxonomy = {
      'AI': ['gpt', 'openai', 'gemini', 'generative', 'ia'],
      'HARDWARE': ['nvidia', 'amd', 'chip', 'gpu'],
      'CYBER': ['hacker', 'security', 'vulnerability', 'seguran√ßa']
    };
    for (const [category, keywords] of Object.entries(taxonomy)) {
      if (keywords.some(k => text.includes(k))) foundTags.push(category);
    }
    if (foundTags.length === 0) foundTags.push('TECH');
    return foundTags.slice(0, 2).map(t => `<span class="news-tag" style="background:#7453f8; color:white; padding:2px 8px; border-radius:10px; font-size:10px; margin-right:5px;">${t}</span>`).join('');
  }

  function getSortedDates() {
    return Object.keys(newsByDate).sort((a,b) => {
      const parse = s => { const [d,m,y]=s.split('/'); return new Date(y,m-1,d); };
      return parse(b) - parse(a);
    });
  }

  function syncLoadMoreButton() {
    const total = getSortedDates().length;
    if (displayedDatesCount >= total) $('#load-more-container').hide();
    else $('#load-more-container').show();
  }

  // ================= EVENTOS DE SELE√á√ÉO E REPORT =================
  $(document).on('change', '.news-checkbox', function() {
    const card = $(this).closest('.news-item-card');
    const data = { title: $(this).data('title'), desc: $(this).data('desc'), source: $(this).data('source') };
    
    if (this.checked) {
      card.addClass('selected');
      selectedArticles.push(data);
    } else {
      card.removeClass('selected');
      selectedArticles = selectedArticles.filter(a => a.title !== data.title);
    }
    
    $('#count').text(selectedArticles.length);
    if (selectedArticles.length > 0) $('#btn-generate-report').fadeIn();
    else $('#btn-generate-report').fadeOut();
  });

  $('#btn-load-more').on('click', () => renderNextBatch());

  $('#btn-generate-report').on('click', function() {
    const $btn = $(this);
    $btn.text('ü§ñ AI ANALYZING...').css('pointer-events','none');
    
    $('#summary-section').fadeIn();
    $('#summary-output').html('<p style="color:white;padding:20px;">‚ö° Processando relat√≥rio executivo...</p>');

    let articlesInput = "";
    selectedArticles.forEach((art, index) => {
        articlesInput += `\nARTICLE ${index+1}: ${art.title}\nCONTENT: ${art.desc}\n`;
    });

    $.ajax({
      url: '/api/chat',
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      data: JSON.stringify({
        messages: [
            { role: 'system', content: 'You are a tech curator. Summarize these articles with technical depth using HTML tags like <b> and <br>.' },
            { role: 'user', content: articlesInput }
        ],
        temperature: 0.3
      }),
      success: res => {
        const text = res.content.replace(/\n/g,'<br>');
        $('#summary-output').html(`<div style="color:#eee;font-size:15px;line-height:1.8;text-align:left;padding:30px;background:#1e1e1e;border-radius:20px;border:1px solid #333;">${text}</div>`);
        $btn.text(`‚ú® Generate AI Report (Selected: ${selectedArticles.length})`).css('pointer-events','auto');
        $('html,body').animate({ scrollTop:$('#summary-section').offset().top - 80 }, 800);
      },
      error: () => {
        $('#summary-output').html('<p style="color:#ff6b6b;padding:20px;">‚ö†Ô∏è Erro ao gerar relat√≥rio. Tente novamente.</p>');
        $btn.text('‚ú® Generate AI Report').css('pointer-events','auto');
      }
    });
  });
  </script>

  <style>
    .news-item-card { position: relative; transition: all 0.3s; border-radius: 20px; overflow: hidden; background: #282b2f; padding-bottom: 20px; }
    .news-item-card.selected { border: 2px solid #7453f8; transform: scale(0.98); }
    .news-checkbox { position: absolute; top: 15px; right: 15px; z-index: 10; width: 20px; height: 20px; cursor: pointer; }
    .news-image-container img { width: 100%; height: 200px; object-fit: cover; }
    .news-content-area { padding: 20px; }
    .news-content-area h4 { font-size: 18px; color: #fff; margin-bottom: 10px; height: 50px; overflow: hidden; }
    .source-tag { font-size: 12px; color: #7453f8; display: block; margin-bottom: 10px; }
    .news-content-area p { font-size: 14px; color: #afafaf; height: 60px; overflow: hidden; }
    .date-section-header { border-left: 4px solid #7453f8; padding-left: 15px; margin-top: 30px; }
  </style>

</body>

</html>

