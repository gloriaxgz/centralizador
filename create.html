<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <title>Transcritor de Podcasts Â· Radix</title>
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>

  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
      <span class="dot"></span>
      <div class="dots"><span></span><span></span><span></span></div>
    </div>
  </div>

  <header class="header-area header-sticky">
    <div class="container">
      <div class="row"><div class="col-12">
        <nav class="main-nav">
          <a href="index.html" class="logo"><img src="assets/images/logo.png" alt="Radix"></a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="create.html" class="active">Transcritor de Podcast</a></li>
            <li><a href="details.html">News Radar</a></li>
            <li><a href="podcast.html">Podcast Radar</a></li>
            <li><a href="table.html">Newsboard</a></li>
          </ul>
          <a class="menu-trigger"><span>Menu</span></a>
        </nav>
      </div></div>
    </div>
  </header>

  <!-- Drawer overlay -->
  <div id="drawer-overlay"></div>

  <!-- Drawer de episÃ³dios -->
  <div id="episode-drawer">
    <div class="drawer-header">
      <h4>EpisÃ³dios</h4>
      <button class="drawer-close-btn" onclick="closeDrawer()">âœ•</button>
    </div>
    <div id="drawer-body"></div>
  </div>

  <div class="page-heading normal-space">
    <div class="container"><div class="row"><div class="col-lg-12">
      <h2>Transcritor de Podcasts</h2>
    </div></div></div>
  </div>

  <div class="item-details-page">
    <div class="container"><div class="row">

      <!-- Credenciais Podcast Index -->
      <div class="col-lg-12">
        <div class="credentials-bar">
          <input type="text"     class="app-input" id="cfg-key"    placeholder="PodcastIndex Key">
          <input type="password" class="app-input" id="cfg-secret" placeholder="PodcastIndex Secret">
          <button onclick="saveCredentials()" class="orange-button">Salvar Chaves</button>
        </div>
      </div>

      <!-- Busca de podcast -->
      <div class="col-lg-12">
        <div class="section-heading">
          <div class="line-dec"></div>
          <h2>Busque um Podcast ou Cole o Link</h2>
        </div>
        <div class="search-wrap" style="margin-bottom:30px;">
          <input type="text" class="search-input" id="podcast-search-input"
                 placeholder="Pesquisar podcast (ex: Flow, Lex Fridman...)">
          <button class="search-btn" onclick="searchPodcasts()">Buscar</button>
        </div>
        <div id="podcast-results-grid"></div>
      </div>

      <!-- URL direta -->
      <div class="col-lg-12">
        <form id="transcription-form">
          <div class="row">
            <div class="col-lg-12">
              <fieldset>
                <label for="audio-url" style="color:#ccc; font-size:13px; display:block; margin-bottom:8px;">Link Direto do Ãudio (.mp3)</label>
                <input type="text" class="app-input" id="audio-url"
                       placeholder="https://exemplo.com/audio.mp3" required>
              </fieldset>
            </div>
            <div class="col-lg-12" style="margin-top:16px;">
              <fieldset>
                <button type="submit" id="form-submit" class="orange-button">Iniciar TranscriÃ§Ã£o</button>
              </fieldset>
            </div>
          </div>
        </form>
      </div>

      <!-- Resultados -->
      <div class="col-lg-12" id="section-resultados" style="display:none;">

        <div class="section-heading" style="margin-top:50px;">
          <div class="line-dec"></div>
          <h2>Sua <em>TranscriÃ§Ã£o</em></h2>
        </div>

        <div class="action-buttons">
          <button class="btn-toggle" id="toggle-transcricao">â–¼ Expandir Texto</button>
          <button class="btn-copy"   id="copy-transcricao">Copiar TranscriÃ§Ã£o</button>
        </div>

        <div id="resultado-container" class="collapsed">
          <p id="texto-transcrito"></p>
        </div>

        <!-- TÃ³picos -->
        <div id="container-topicos" style="display:none; margin-top:50px;">
          <div class="section-heading">
            <div class="line-dec"></div>
            <h2>O que deseja <em>Resumir?</em></h2>
          </div>

          <div id="lista-topicos" class="topic-selection-card">
            <p style="color:#fff; text-align:center;">Analisando assuntos e gerando prÃ©vias robustas...</p>
          </div>

          <div style="text-align:center; margin-top:30px; display:flex; gap:14px; justify-content:center; flex-wrap:wrap; align-items:center;">
            <button id="btn-gerar-resumo-final" class="orange-button">
              Gerar RelatÃ³rio Individualizado
            </button>
            <a href="javascript:void(0)" id="btn-send-to-board" class="btn-send-board">
              ğŸ“‹ Enviar TÃ³picos para Newsboard
            </a>
          </div>
        </div>

        <!-- RelatÃ³rio final -->
        <div id="resumo-wrapper" style="display:none; margin-top:50px;">
          <div class="section-heading">
            <div class="line-dec"></div>
            <h2>RelatÃ³rio <em>Executivo por TÃ³pico</em></h2>
          </div>
          <div class="action-buttons">
            <button class="btn-copy" id="copy-resumo">Copiar RelatÃ³rio Completo</button>
          </div>
          <div id="resultado-resumo"></div>
        </div>

      </div>
      <!-- /Resultados -->

    </div></div>
  </div>

  <div id="toast"></div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
  $(document).ready(function () {

    // â”€â”€ Credenciais Podcast Index â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let API_KEY    = localStorage.getItem('pi_key')    || '';
    let API_SECRET = localStorage.getItem('pi_secret') || '';

    if (API_KEY)    $('#cfg-key').val('â€¢â€¢â€¢â€¢â€¢â€¢');
    if (API_SECRET) $('#cfg-secret').val('â€¢â€¢â€¢â€¢â€¢â€¢');

    window.saveCredentials = function () {
      const k = $('#cfg-key').val().trim();
      const s = $('#cfg-secret').val().trim();
      if (!k || !s || k === 'â€¢â€¢â€¢â€¢â€¢â€¢') { showToast('Insira credenciais vÃ¡lidas.', '#ff4d6d'); return; }
      API_KEY = k; API_SECRET = s;
      localStorage.setItem('pi_key', k);
      localStorage.setItem('pi_secret', s);
      showToast('âœ“ Credenciais salvas!');
    };

    // â”€â”€ Auth Podcast Index â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function getAuthHeaders() {
      if (!API_KEY || !API_SECRET) throw new Error('NO_CREDENTIALS');
      const epoch = Math.floor(Date.now() / 1000).toString();
      const buf   = new TextEncoder().encode(API_KEY + API_SECRET + epoch);
      const hash  = await crypto.subtle.digest('SHA-1', buf);
      const hex   = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
      return { 'X-Auth-Key': API_KEY, 'X-Auth-Date': epoch, 'Authorization': hex, 'User-Agent': 'PodcastRadar/1.0' };
    }

    // â”€â”€ 1. Busca de podcasts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.searchPodcasts = async function () {
      const q = $('#podcast-search-input').val().trim();
      if (!q) return;
      if (!API_KEY) { showToast('Configure as chaves primeiro!', '#ff4d6d'); return; }

      $('#podcast-results-grid').html('<p style="color:white;grid-column:1/-1;text-align:center;">ğŸ” Buscando podcasts...</p>');
      try {
        const headers = await getAuthHeaders();
        const res  = await fetch(`https://api.podcastindex.org/api/1.0/search/byterm?q=${encodeURIComponent(q)}&max=6`, { headers });
        const data = await res.json();
        const feeds = data.feeds || [];

        if (!feeds.length) {
          $('#podcast-results-grid').html('<p style="color:white;grid-column:1/-1;text-align:center;">Nenhum resultado encontrado.</p>');
          return;
        }
        $('#podcast-results-grid').html(feeds.map(f => `
          <div class="podcast-card" onclick="loadEpisodes(${f.id})">
            <img src="${f.artwork || f.image}" onerror="this.src='assets/images/current-01.jpg'" alt="">
            <h6>${f.title}</h6>
          </div>`).join(''));
      } catch (e) {
        showToast('Erro na busca: ' + e.message, '#ff4d6d');
      }
    };

    // â”€â”€ 2. Carregar episÃ³dios no drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.loadEpisodes = async function (feedId) {
      document.getElementById('drawer-overlay').classList.add('open');
      document.getElementById('episode-drawer').classList.add('open');
      document.body.style.overflow = 'hidden';
      $('#drawer-body').html('<div class="episode-item"><small style="color:var(--cyan)">Carregando...</small></div>');
      try {
        const headers = await getAuthHeaders();
        const res  = await fetch(`https://api.podcastindex.org/api/1.0/episodes/byfeedid?id=${feedId}&max=30`, { headers });
        const data = await res.json();
        const items = data.items || [];
        $('#drawer-body').html(items.map(ep => {
          const date = new Date(ep.datePublished * 1000).toLocaleDateString('pt-BR');
          return `
            <div class="episode-item" onclick="selectEpisode('${ep.enclosureUrl}')">
              <small>ğŸ“… ${date}</small>
              <p>${ep.title}</p>
            </div>`;
        }).join('') || '<p style="color:white;padding:20px;">Nenhum episÃ³dio encontrado.</p>');
      } catch (e) {
        $('#drawer-body').html('<p style="color:white;padding:20px;">Erro ao carregar episÃ³dios.</p>');
      }
    };

    window.selectEpisode = function (url) {
      $('#audio-url').val(url);
      window.closeDrawer();
      showToast('âœ“ Link selecionado!');
      $('html, body').animate({ scrollTop: $('#transcription-form').offset().top - 100 }, 500);
    };

    window.closeDrawer = function () {
      document.getElementById('episode-drawer').classList.remove('open');
      document.getElementById('drawer-overlay').classList.remove('open');
      document.body.style.overflow = '';
    };
    document.getElementById('drawer-overlay').addEventListener('click', window.closeDrawer);

    // â”€â”€ 3. TranscriÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#transcription-form').on('submit', function (e) {
      e.preventDefault();
      const linkAudio = $('#audio-url').val().trim();
      if (!linkAudio) { showToast('Insira uma URL vÃ¡lida.', '#ff4d6d'); return; }

      const $btn = $('#form-submit');
      $btn.html('<i class="fa fa-spinner fa-spin"></i> Processando (Whisper)...').prop('disabled', true);

      $('#section-resultados').fadeIn();
      $('#texto-transcrito').text('Baixando e transcrevendo... Isso pode levar alguns minutos para episÃ³dios longos.');
      $('#container-topicos, #resumo-wrapper').hide();

      $.ajax({
        url: '/api/transcribe',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ audioUrl: linkAudio }),
        success: function (response) {
          const texto = response.transcript;
          $('#texto-transcrito').text(texto);
          showToast(response.cached ? 'ğŸš€ Recuperado do cache!' : 'âœ… TranscriÃ§Ã£o finalizada!');
          $btn.text('Iniciar Nova TranscriÃ§Ã£o').prop('disabled', false);
          extrairTopicos(texto);
        },
        error: function (err) {
          $('#texto-transcrito').text('Erro: ' + (err.responseJSON?.error || 'Falha na API.'));
          $btn.text('Tentar Novamente').prop('disabled', false);
        }
      });
    });

    // â”€â”€ 4. ExtraÃ§Ã£o de tÃ³picos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function extrairTopicos(texto) {
      $('#container-topicos').fadeIn();
      $('#lista-topicos').html('<p style="color:white;text-align:center;"><i class="fa fa-cog fa-spin"></i> IA identificando temas estratÃ©gicos...</p>');

      $.ajax({
        url: '/api/chat',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          messages: [
            { role: 'system', content: 'Analyze the transcript and identify 7 main topics. Ignore meta-talk about the podcast itself. For each topic: 1. Title (Professional). 2. A robust summary (3-5 sentences). Return ONLY a JSON array: [{"title": "...", "summary": "..."}]' },
            { role: 'user',   content: 'Transcript: ' + texto.substring(0, 18000) }
          ],
          temperature: 0.3
        }),
        success: function (response) {
          try {
            const topicos = JSON.parse(response.content.replace(/```json|```/g, ''));
            $('#lista-topicos').html(topicos.map(t => {
              const searchLink = `https://www.google.com/search?q=${encodeURIComponent(t.title)}+news+ai+tech&tbm=nws`;
              return `
                <label class="topic-item">
                  <input type="checkbox" name="podcast-topic" value="${t.title}" data-summary="${t.summary.replace(/"/g,'&quot;')}">
                  <div class="topic-content">
                    <span class="topic-title">${t.title}</span>
                    <span class="topic-desc">${t.summary}</span>
                    <a href="${searchLink}" target="_blank" class="news-link"><i class="fa fa-external-link"></i> Ver notÃ­cias</a>
                  </div>
                </label>`;
            }).join(''));
          } catch (e) {
            $('#lista-topicos').text('Erro ao processar tÃ³picos.');
          }
        }
      });
    }

    // â”€â”€ 5. RelatÃ³rio final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-gerar-resumo-final').on('click', function () {
      const selecionados = $("input[name='podcast-topic']:checked").map(function () { return $(this).val(); }).get();
      if (!selecionados.length) return alert('Selecione ao menos um tÃ³pico!');

      const $btn = $(this);
      $btn.text('â³ Gerando...').prop('disabled', true);
      $('#resumo-wrapper').fadeIn();
      $('#resultado-resumo').html('Consolidando anÃ¡lise tÃ©cnica...');

      $.ajax({
        url: '/api/chat',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          messages: [{ role: 'user', content: `Summarize the following transcript. Sections for: ${selecionados.join(', ')}. Format with <h3>, <b> and <br>. Transcript: ${$('#texto-transcrito').text().substring(0, 20000)}` }],
          temperature: 0.2
        }),
        success: function (response) {
          $('#resultado-resumo').html(response.content.replace(/\n/g, '<br>'));
          $btn.text('Gerar RelatÃ³rio Individualizado').prop('disabled', false);
          $('html,body').animate({ scrollTop: $('#resumo-wrapper').offset().top - 50 }, 600);
        }
      });
    });

    // â”€â”€ 6. Enviar para Newsboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-send-to-board').on('click', async function () {
      const selecionados = $("input[name='podcast-topic']:checked").map(function () {
        return { title: $(this).val(), notes: $(this).data('summary') || '', source: 'Podcast', url: '', tags: 'Podcast' };
      }).get();
      if (!selecionados.length) return alert('Selecione um tÃ³pico.');

      try {
        const res = await fetch('/api/newsboard?action=pending', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ articles: selecionados }),
        });
        if (res.ok) {
          showToast(`âœ“ ${selecionados.length} itens enviados ao Newsboard`);
          window.open('table.html', '_blank');
        }
      } catch (e) { showToast('Erro ao enviar.', '#ff4d6d'); }
    });

    // â”€â”€ 7. Toggle e cÃ³pia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#toggle-transcricao').on('click', function () {
      const c = $('#resultado-container');
      c.toggleClass('collapsed expanded');
      $(this).text(c.hasClass('expanded') ? 'â–² Recolher Texto' : 'â–¼ Expandir Texto');
    });

    $('.btn-copy').on('click', function () {
      const target = $(this).attr('id') === 'copy-transcricao' ? '#texto-transcrito' : '#resultado-resumo';
      navigator.clipboard.writeText($(target).text()).then(() => {
        const old = $(this).text();
        $(this).text('âœ“ Copiado!');
        setTimeout(() => $(this).text(old), 2000);
      });
    });
  });
  </script>
</body>
</html>