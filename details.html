<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <title>News Radar Â· Radix</title>
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/fontawesome.css">
  <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
  <link rel="stylesheet" href="assets/css/owl.css">
  <link rel="stylesheet" href="assets/css/animate.css">
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>

  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner"><span class="dot"></span><div class="dots"><span></span><span></span><span></span></div></div>
  </div>

  <header class="header-area header-sticky">
    <div class="container">
      <div class="row"><div class="col-12">
        <nav class="main-nav">
          <a href="index.html" class="logo"><img src="assets/images/logo.png" alt="Radix"></a>
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="create.html">Transcritor de Podcast</a></li>
            <li><a href="details.html" class="active">News Radar</a></li>
            <li><a href="podcast.html">Podcast Radar</a></li>
            <li><a href="table.html">Newsboard</a></li>
          </ul>
          <a class="menu-trigger"><span>Menu</span></a>
        </nav>
      </div></div>
    </div>
  </header>

  <div class="page-heading normal-space">
    <div class="container"><div class="row"><div class="col-lg-12">
      <h2>News Radar</h2>
      <p style="color:#a2ff0c; font-weight:bold;">Leia e analise notÃ­cias relacionadas Ã  tecnologia e IA</p>
    </div></div></div>
  </div>

  <div class="item-details-page">
    <div class="container"><div class="row">

      <div class="col-lg-12">
        <div class="section-heading">
          <div class="line-dec"></div>
          <h3>As notÃ­cias sÃ£o atualizadas automaticamente de hora em hora.</h3>
        </div>
      </div>

      <div class="col-lg-12 text-center" style="margin-bottom:40px;">
        <div class="main-button">
          <a href="javascript:void(0)" id="btn-refresh-news">Atualizar NotÃ­cias Agora</a>
        </div>
        <p id="refresh-status" style="color:var(--cyan); font-size:12px; margin-top:10px; display:none;">
          Sincronizando com GNews...
        </p>
      </div>

      <div class="col-lg-12" id="news-feed-container">
        <h5 class="text-center" style="color:white; padding:50px;">Buscando as notÃ­cias mais recentes no banco...</h5>
      </div>

      <div class="col-lg-12 text-center" style="margin-top:30px;">
        <div id="load-more-container" style="display:none;">
          <div class="border-button">
            <a href="javascript:void(0)" id="btn-load-more">Mostrar dias anteriores</a>
          </div>
        </div>
        <div style="margin-top:30px; display:flex; gap:14px; justify-content:center; flex-wrap:wrap; align-items:center;">
          <div class="main-button">
            <a href="javascript:void(0)" id="btn-generate-report" style="display:none; background-color:var(--purple); border-color:var(--purple); padding:15px 30px;">
              Gerar resumo com IA (<span id="count">0</span>)
            </a>
          </div>
          <a href="javascript:void(0)" id="btn-send-to-board" class="btn-send-board" style="display:none;">
            Enviar para Newsboard (<span id="count-board">0</span>)
          </a>
        </div>
      </div>

      <!-- SeÃ§Ã£o de relatÃ³rio IA -->
      <div class="col-lg-12" id="summary-section" style="display:none;">
        <div class="section-heading" style="margin-top:60px;">
          <div class="line-dec"></div>
          <h2>AI <em>Executive Summary</em></h2>
        </div>

        <div class="report-tabs">
          <button class="report-tab-btn active" data-tab="tab-summary">Resumo Executivo</button>
          <button class="report-tab-btn" data-tab="tab-relevance">Por que Ã© relevante para a Radix?</button>
        </div>

        <div id="tab-summary" class="report-tab-content active">
          <div id="summary-output" class="report-box">
            <p style="color:#aaa; padding:20px;">Aguardando geraÃ§Ã£o do relatÃ³rio...</p>
          </div>
        </div>
        <div id="tab-relevance" class="report-tab-content">
          <div id="relevance-output" class="report-box">
            <p style="color:#aaa; padding:20px;">Aguardando anÃ¡lise de relevÃ¢ncia...</p>
          </div>
        </div>
      </div>

    </div></div>
  </div>

  <div id="toast"></div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/custom.js"></script>

  <script>
  // â”€â”€ Estado global â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let newsByDate = {}, selectedArticles = [], displayedDatesCount = 0;
  const DATES_PER_LOAD = 2;

  // Contexto da Radix movido para o backend (api/chat.py)
  // O frontend envia apenas os artigos â€” o backend injeta o contexto estratÃ©gico.

  $(document).ready(async function () {
    await carregarNoticias();
  });

  // â”€â”€ Carregamento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function carregarNoticias(force = false) {
    try {
      if (force) $('#refresh-status').fadeIn();
      const response = await fetch(force ? '/api/news?force=true' : '/api/news');
      const articles = await response.json();

      if (!articles || articles.length === 0) {
        $('#news-feed-container').html('<h5 class="text-center" style="color:white;padding:50px;">Nenhuma notÃ­cia disponÃ­vel no momento.</h5>');
        return;
      }

      newsByDate = {}; displayedDatesCount = 0; selectedArticles = [];
      $('#count, #count-board').text('0');
      $('#btn-generate-report, #btn-send-to-board').hide();

      articles.forEach(art => {
        const dateKey = new Date(art.publishedAt).toLocaleDateString('pt-BR');
        if (!newsByDate[dateKey]) newsByDate[dateKey] = [];
        newsByDate[dateKey].push(art);
      });

      $('#news-feed-container').empty();
      renderNextBatch();
      $('#refresh-status').fadeOut();
    } catch (e) {
      console.error(e);
      $('#news-feed-container').html('<h5 class="text-center" style="color:#ff6b6b;padding:50px;">Erro ao sincronizar com o banco.</h5>');
      $('#refresh-status').fadeOut();
    }
  }

  $('#btn-refresh-news').on('click', async function () {
    const $btn = $(this);
    $btn.css({ 'pointer-events': 'none', opacity: '0.5' }).text('â³ Atualizando...');
    await carregarNoticias(true);
    $btn.css({ 'pointer-events': 'auto', opacity: '1' }).text('Atualizar NotÃ­cias Agora');
  });

  // â”€â”€ RenderizaÃ§Ã£o em lotes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function renderNextBatch() {
    const sortedDates = getSortedDates();
    const batch = sortedDates.slice(displayedDatesCount, displayedDatesCount + DATES_PER_LOAD);

    for (const date of batch) {
      const safeId   = `carousel-${date.replace(/\//g, '-')}`;
      const articles = newsByDate[date];
      const cardsHtml = await buildCards(articles);

      $('#news-feed-container').append(`
        <div class="carousel-date-row" style="margin-bottom:50px;">
          <h4 class="date-section-header" style="color:#fff; margin-bottom:20px; font-size:20px;">
            ğŸ“… ${date} <span style="font-size:14px; color:var(--purple);">(${articles.length} notÃ­cias)</span>
          </h4>
          <div id="${safeId}" class="owl-carousel owl-theme news-carousel">${cardsHtml}</div>
        </div>`);

      $(`#${safeId}`).owlCarousel({
        items: 3, margin: 30, dots: false, nav: true,
        navText: ["<i class='fa fa-chevron-left'></i>", "<i class='fa fa-chevron-right'></i>"],
        responsive: { 0: { items: 1 }, 768: { items: 2 }, 1200: { items: 3 } }
      });
    }

    displayedDatesCount += batch.length;
    getSortedDates().length > displayedDatesCount
      ? $('#load-more-container').show()
      : $('#load-more-container').hide();
  }

  async function buildCards(articles) {
    let html = '';
    articles.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
    for (const art of articles) {
      const tags    = generateTags(art.title, art.description);
      const title   = (art.title       || 'Sem tÃ­tulo').replace(/"/g, '&quot;');
      const desc    = (art.description || '').replace(/"/g, '&quot;');
      const img     = art.image || 'assets/images/current-01.jpg';
      const source  = art.source?.name || 'News';
      const url     = art.url || '#';
      html += `
        <div class="item">
          <div class="news-item-card">
            <input type="checkbox" class="news-checkbox"
                   data-title="${title}" data-desc="${desc}"
                   data-source="${source}" data-url="${url}"
                   data-tags="${tags.replace(/<[^>]+>/g,'').trim()}">
            <div class="news-image-container">
              <img src="${img}" loading="lazy" onerror="this.src='assets/images/current-01.jpg'" alt="">
            </div>
            <div class="news-content-area">
              <h4>${art.title || 'Sem TÃ­tulo'}</h4>
              <a href="${url}" target="_blank"><span class="source-tag">@${source}</span></a>
              <p>${art.description || 'Clique para ler a matÃ©ria completa.'}</p>
              <div class="tags-list">${tags}</div>
            </div>
          </div>
        </div>`;
    }
    return html;
  }

  function generateTags(title, desc) {
    const text = (title + ' ' + desc).toLowerCase();
    const taxonomy = {
      'AI':     ['gpt','openai','gemini','generative','ia','llm','claude'],
      'HARDWARE': ['nvidia','amd','chip','gpu','intel'],
      'CYBER':  ['hacker','security','vulnerability','seguranÃ§a'],
    };
    const found = Object.entries(taxonomy)
      .filter(([, kws]) => kws.some(k => text.includes(k)))
      .map(([cat]) => cat);
    return (found.length ? found : ['TECH'])
      .slice(0, 2)
      .map(t => `<span class="news-tag">${t}</span>`)
      .join('');
  }

  function getSortedDates() {
    return Object.keys(newsByDate).sort((a, b) => {
      const parse = s => { const [d,m,y] = s.split('/'); return new Date(y, m-1, d); };
      return parse(b) - parse(a);
    });
  }

  // â”€â”€ SeleÃ§Ã£o de cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $(document).on('change', '.news-checkbox', function () {
    const card = $(this).closest('.news-item-card');
    const data = { title: $(this).data('title'), desc: $(this).data('desc'), source: $(this).data('source'), url: $(this).data('url'), tags: $(this).data('tags') };

    if (this.checked) { card.addClass('selected'); selectedArticles.push(data); }
    else              { card.removeClass('selected'); selectedArticles = selectedArticles.filter(a => a.title !== data.title); }

    const n = selectedArticles.length;
    $('#count, #count-board').text(n);
    if (n > 0) {
      $('#btn-generate-report').fadeIn();
      $('#btn-send-to-board').fadeIn().css('display', 'inline-flex');
    } else {
      $('#btn-generate-report, #btn-send-to-board').fadeOut();
    }
  });

  // â”€â”€ Troca de abas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $(document).on('click', '.report-tab-btn', function () {
    const target = $(this).data('tab');
    $('.report-tab-btn').removeClass('active');
    $('.report-tab-content').removeClass('active');
    $(this).addClass('active');
    $(`#${target}`).addClass('active');
  });

  // â”€â”€ Enviar para Newsboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('#btn-send-to-board').on('click', async function () {
    if (!selectedArticles.length) return;
    const $btn = $(this);
    $btn.css({ 'pointer-events': 'none', opacity: '0.6' });
    try {
      await fetch('/api/newsboard?action=pending', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ articles: selectedArticles.map(a => ({ title: a.title, url: a.url, source: a.source, tags: a.tags })) }),
      });
      const orig = $btn.html();
      $btn.html('Enviado! âœ“').css({ background: 'var(--cyan-dim)', opacity: '1' });
      setTimeout(() => $btn.html(orig).css({ background: 'transparent', 'pointer-events': 'auto' }), 2200);
      window.open('table.html', '_blank');
    } catch (e) {
      showToast('Erro ao enviar.', '#ff4d6d');
      $btn.css({ 'pointer-events': 'auto', opacity: '1' });
    }
  });

  // â”€â”€ Gerar relatÃ³rio IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('#btn-generate-report').on('click', function () {
    const $btn = $(this);
    $btn.text('Aguarde...').css('pointer-events', 'none');

    $('#summary-section').fadeIn();
    $('.report-tab-btn[data-tab="tab-summary"]').trigger('click');
    $('#summary-output').html('<div class="report-loading"><span class="report-spinner"></span> Gerando resumo executivo...</div>');
    $('#relevance-output').html('<div class="report-loading"><span class="report-spinner"></span> Analisando relevÃ¢ncia para a Radix...</div>');
    $('html,body').animate({ scrollTop: $('#summary-section').offset().top - 80 }, 600);

    let articlesInput = selectedArticles.map((art, i) =>
      `\nARTIGO ${i+1}:\nTÃ­tulo: ${art.title}\nDescriÃ§Ã£o: ${art.desc}\nFonte: ${art.source}\n`
    ).join('');

    const callSummary = $.ajax({
      url: '/api/chat', method: 'POST', contentType: 'application/json',
      data: JSON.stringify({
        messages: [
          { role: 'system', content: 'VocÃª Ã© um curador de tecnologia. Analise os artigos e gere um resumo executivo aprofundado em portuguÃªs. Use tags HTML como <b>, <br> e <ul><li>.' },
          { role: 'user',   content: articlesInput }
        ],
        temperature: 0.3
      })
    });

    // O contexto da Radix Ã© injetado no backend via variÃ¡vel de ambiente RADIX_CONTEXT
    const callRelevance = $.ajax({
      url: '/api/chat', method: 'POST', contentType: 'application/json',
      data: JSON.stringify({
        messages: [
          { role: 'system', content: 'radix_relevance_analysis' }, // backend substitui pelo prompt completo
          { role: 'user',   content: articlesInput }
        ],
        temperature: 0.4
      })
    });

    $.when(callSummary, callRelevance).then(
      function (resSummary, resRelevance) {
        $('#summary-output').html(`<div class="report-content">${resSummary[0].content.replace(/\n/g,'<br>')}</div>`);
        $('#relevance-output').html(`<div class="report-content">${resRelevance[0].content.replace(/\n/g,'<br>')}</div>`);
        $btn.text(`Gerar resumo com IA (${selectedArticles.length})`).css('pointer-events', 'auto');
      },
      function () {
        $('#summary-output, #relevance-output').html('<p style="color:#ff6b6b;padding:20px;">âš ï¸ Erro ao gerar. Tente novamente.</p>');
        $btn.text('Gerar resumo com IA').css('pointer-events', 'auto');
      }
    );
  });

  $('#btn-load-more').on('click', () => renderNextBatch());
  </script>
</body>
</html>
